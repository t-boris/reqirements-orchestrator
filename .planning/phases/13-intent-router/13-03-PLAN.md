---
phase: 13-intent-router
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/graph/nodes/discussion.py
  - src/graph/graph.py
  - src/slack/handlers.py
autonomous: true
---

<objective>
Implement DiscussionFlow - single response for casual interactions, no state, no thread creation.

Purpose: When user sends a greeting or simple question, MARO responds politely once without triggering any workflow.
Output: Discussion node that generates a single helpful response, handler support, Jira guardrails enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-intent-router/13-CONTEXT.md
@.planning/phases/13-intent-router/13-01-SUMMARY.md

Relevant source files:
@src/graph/graph.py
@src/graph/intent.py
@src/slack/onboarding.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discussion_node for light responses</name>
  <files>src/graph/nodes/discussion.py</files>
  <action>
Create `src/graph/nodes/discussion.py` with:

1. **Light response generation**:
```python
DISCUSSION_PROMPT = '''You are MARO, a helpful assistant that turns discussions into Jira tickets and provides architectural/security reviews.

User said: {message}

Respond in 1-2 sentences max. Be helpful but brief.
If they're asking what you can do, mention: creating Jira tickets, reviewing ideas as PM/Architect/Security.
Don't offer to do anything specific unless asked.
End with a natural conversation prompt if appropriate.
'''
```

2. **async def discussion_node(state: AgentState) -> dict**:
- Get latest human message
- Call LLM with DISCUSSION_PROMPT (use smaller/faster model if available)
- Return:
  ```python
  {
      "decision_result": {
          "action": "discussion",
          "message": response_text,
      }
  }
  ```
- Log: "Discussion response generated"

3. **Key principle from 13-CONTEXT.md**:
> DISCUSSION никогда не должен:
> - создавать тред
> - создавать draft
> - вызывать Jira
> - запускать validators

This node ONLY generates a response. No draft, no Jira, no state updates beyond decision_result.
  </action>
  <verify>`python -m py_compile src/graph/nodes/discussion.py`</verify>
  <done>discussion_node generates brief response without triggering any workflow</done>
</task>

<task type="auto">
  <name>Task 2: Wire discussion_node into graph and add guardrails</name>
  <files>src/graph/graph.py</files>
  <action>
Update graph to include discussion flow:

1. Import: `from src.graph.nodes.discussion import discussion_node`

2. Add node: `workflow.add_node("discussion", discussion_node)`

3. Update conditional edge from intent_router:
```python
workflow.add_conditional_edges(
    "intent_router",
    route_after_intent,
    {
        "ticket_flow": "extraction",
        "review_flow": "review",
        "discussion_flow": "discussion",  # Now routes to discussion node
    }
)
```

4. Discussion goes to END:
```python
workflow.add_edge("discussion", END)
```

5. Update docstring with complete flow:
```
Graph structure:
  START -> intent_router -> {ticket_flow | review_flow | discussion_flow}

  ticket_flow: extraction -> should_continue -> validation -> decision -> END
  review_flow: review -> END
  discussion_flow: discussion -> END

Intent classification:
  - TICKET: User wants Jira ticket created
  - REVIEW: User wants analysis/review without Jira
  - DISCUSSION: Casual conversation, single response

Guardrails:
  - ReviewFlow and DiscussionFlow do NOT access Jira
  - jira_search, jira_create blocked at code level
  - Override only via explicit mode switch to TicketFlow
```
  </action>
  <verify>`python -c "from src.graph.graph import create_graph; g = create_graph(); print('OK')"`</verify>
  <done>discussion_flow routes to discussion node, graph docstring documents guardrails</done>
</task>

<task type="auto">
  <name>Task 3: Handle discussion action in Slack handlers</name>
  <files>src/slack/handlers.py</files>
  <action>
Add handling for "discussion" action in handlers.py:

```python
elif action == "discussion":
    # Discussion response - single reply, no thread creation
    discussion_msg = decision_result.get("message", "")

    # Post directly to channel (not thread) unless already in thread
    # Key: Discussion should respond WHERE the user mentioned us
    await send_message(
        client=client,
        channel=channel_id,
        thread_ts=thread_ts if thread_ts else None,  # Reply in-place
        text=discussion_msg,
    )
    # No state updates, no progress tracker, no thread creation
    # Just respond and stop
```

Important: Discussion responses do NOT create new threads. They reply in the same context where mentioned.
  </action>
  <verify>`python -m py_compile src/slack/handlers.py`</verify>
  <done>Discussion responses sent inline without creating threads or state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile src/graph/nodes/discussion.py` passes
- [ ] `python -m py_compile src/graph/graph.py` passes
- [ ] `python -m py_compile src/slack/handlers.py` passes
- [ ] `python -c "from src.graph.graph import create_graph; g = create_graph(); print('OK')"` succeeds
</verification>

<success_criteria>

- DiscussionFlow generates brief, helpful responses
- No thread creation for discussion intent
- No Jira operations triggered
- No draft state created
- Response posted in-place (channel or existing thread)
- Graph docstring documents intent routing and guardrails
</success_criteria>

<output>
After completion, create `.planning/phases/13-intent-router/13-03-SUMMARY.md`
</output>
