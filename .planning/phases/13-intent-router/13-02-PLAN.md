---
phase: 13-intent-router
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/graph/nodes/review.py
  - src/graph/graph.py
  - src/slack/handlers.py
autonomous: true
---

<objective>
Implement ReviewFlow - persona-based architectural analysis without Jira operations.

Purpose: When user asks for review/analysis, MARO should provide thoughtful architectural feedback like a senior engineer, not trigger ticket creation pipeline.
Output: Review node that generates analysis using active persona, handler support for review responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-intent-router/13-CONTEXT.md
@.planning/phases/13-intent-router/13-01-SUMMARY.md

Relevant source files:
@src/graph/graph.py
@src/graph/intent.py
@src/personas/loader.py
@src/slack/handlers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review_node for persona-based analysis</name>
  <files>src/graph/nodes/review.py</files>
  <action>
Create `src/graph/nodes/review.py` with:

1. **Review prompt template** that produces senior-engineer-style analysis:
```python
REVIEW_PROMPT = '''You are {persona_name}, a senior {persona_role}.

Analyze this request thoughtfully, as if thinking out loud:

{context}

User request: {message}

Provide analysis covering:
1. **Understanding** - What you understand about the request
2. **Components & Flows** - Key technical elements involved
3. **Risks & Concerns** - What could go wrong
4. **Alternatives** - Other approaches to consider
5. **Open Questions** - What needs clarification

Be conversational and thorough. This is a discussion, not a ticket.
Think out loud like a senior engineer would.
'''
```

2. **async def review_node(state: AgentState) -> dict**:
- Get intent_result for persona_hint
- Load persona knowledge using `src/personas/loader.py`
- Get latest human message + conversation context
- Call LLM with REVIEW_PROMPT + persona knowledge
- Return:
  ```python
  {
      "decision_result": {
          "action": "review",
          "message": analysis_text,
          "persona": persona_name,
          "topic": intent_result.get("topic"),
      }
  }
  ```
- Log: persona used, topic, message length

3. **Persona selection logic**:
- If intent_result.persona_hint exists → use that persona
- Elif state.persona exists → use current persona
- Else → default to "architect" (most common for reviews)

Do NOT import or call any Jira-related code. This is read-only analysis.
  </action>
  <verify>`python -m py_compile src/graph/nodes/review.py`</verify>
  <done>review_node generates persona-based analysis, returns review action in decision_result</done>
</task>

<task type="auto">
  <name>Task 2: Wire review_node into graph</name>
  <files>src/graph/graph.py</files>
  <action>
Update graph to include review flow:

1. Import: `from src.graph.nodes.review import review_node`

2. Add node: `workflow.add_node("review", review_node)`

3. Update conditional edge from intent_router:
```python
workflow.add_conditional_edges(
    "intent_router",
    route_after_intent,
    {
        "ticket_flow": "extraction",
        "review_flow": "review",      # Now routes to review node
        "discussion_flow": END,       # Plan 03
    }
)
```

4. Review goes to END (handler sends response):
```python
workflow.add_edge("review", END)
```

5. Update docstring:
```
Graph structure:
  START -> intent_router -> {ticket_flow | review_flow | discussion_flow}

  ticket_flow: extraction -> validation -> decision -> END
  review_flow: review -> END
  discussion_flow: (Plan 03)
```
  </action>
  <verify>`python -c "from src.graph.graph import create_graph; g = create_graph(); print('OK')"`</verify>
  <done>review_flow routes to review node, then END</done>
</task>

<task type="auto">
  <name>Task 3: Handle review action in Slack handlers</name>
  <files>src/slack/handlers.py</files>
  <action>
Find the section in handlers.py that processes decision_result after graph run.
Currently it handles "ask", "preview", "ready_to_create", "intro", "nudge", "hint".

Add handling for "review" action:

```python
elif action == "review":
    # Review response - just post the analysis
    review_msg = decision_result.get("message", "")
    persona = decision_result.get("persona", "")

    # Format as review (persona indicator + analysis)
    if persona:
        prefix = f"*{persona.title()} Review:*\n\n"
    else:
        prefix = ""

    await send_message(
        client=client,
        channel=channel_id,
        thread_ts=thread_ts,
        text=prefix + review_msg,
    )

    # Add "Turn into ticket" button for transition (Plan 04)
    # For now, just post the review text
```

Keep it simple - just format and send the review analysis.
The "Turn into ticket" button will be added in Plan 04.
  </action>
  <verify>Verify handler file syntax: `python -m py_compile src/slack/handlers.py`</verify>
  <done>Slack handler renders review responses with persona prefix</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile src/graph/nodes/review.py` passes
- [ ] `python -m py_compile src/graph/graph.py` passes
- [ ] `python -m py_compile src/slack/handlers.py` passes
- [ ] `python -c "from src.graph.graph import create_graph; g = create_graph(); print('OK')"` succeeds
</verification>

<success_criteria>

- ReviewFlow produces thoughtful, conversational analysis
- Persona knowledge is loaded and used in prompt
- Review responses display in Slack with persona prefix
- No Jira operations triggered during review flow
- Graph correctly routes REVIEW intent to review node
</success_criteria>

<output>
After completion, create `.planning/phases/13-intent-router/13-02-SUMMARY.md`
</output>
