---
phase: 13-intent-router
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graph/intent.py
  - src/schemas/state.py
  - src/graph/graph.py
autonomous: true
---

<objective>
Create IntentRouter node that classifies user messages into TICKET, REVIEW, or DISCUSSION flows.

Purpose: Enable MARO to understand what the user wants before processing, rather than treating all messages as ticket creation requests.
Output: IntentRouter node with structured classification result, integrated as new entry point in graph.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-intent-router/13-CONTEXT.md

Relevant source files:
@src/graph/graph.py
@src/schemas/state.py
@src/slack/onboarding.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IntentResult schema and IntentRouter node</name>
  <files>src/graph/intent.py</files>
  <action>
Create new file `src/graph/intent.py` with:

1. **IntentType enum**: TICKET, REVIEW, DISCUSSION

2. **IntentResult Pydantic model**:
```python
{
  "intent": IntentType,
  "confidence": float (0.0-1.0),
  "persona_hint": Optional[Literal["pm", "architect", "security"]],
  "topic": Optional[str],
  "reasons": list[str]  # e.g., ["pattern: propose architecture", "keyword: risks"]
}
```

3. **Explicit override detection** (checked BEFORE LLM, force confidence=1.0):
- "create a ticket" / "draft a ticket" / "jira story" → TICKET
- "/maro ticket" → TICKET
- "review as security/architect/pm" → REVIEW with persona_hint
- "propose architecture" / "analyze" / "risks" / "evaluate" → REVIEW
- "/maro review" → REVIEW
- "don't create a ticket" → REVIEW (explicit override)

4. **LLM classification** for ambiguous cases:
Prompt should classify into TICKET/REVIEW/DISCUSSION with confidence.
- TICKET: User wants a Jira ticket created
- REVIEW: User wants analysis/feedback without Jira operations
- DISCUSSION: Casual greeting, simple question, no action needed

5. **async def intent_router_node(state: AgentState) -> dict**:
- Get latest human message
- Check explicit overrides first (pattern matching)
- If no override, use LLM classification
- Return partial state: `{"intent_result": IntentResult.model_dump()}`
- Log: intent, confidence, reasons

Pattern matching first, LLM fallback for nuanced cases. Never call LLM if pattern is explicit.
  </action>
  <verify>Python syntax check: `python -m py_compile src/graph/intent.py`</verify>
  <done>IntentRouter node exists with explicit overrides and LLM fallback, returns structured IntentResult</done>
</task>

<task type="auto">
  <name>Task 2: Extend AgentState with intent fields</name>
  <files>src/schemas/state.py</files>
  <action>
Add to AgentState TypedDict:

```python
# Intent routing (Phase 13)
intent_result: Optional[dict[str, Any]]  # IntentResult.model_dump()
# Structure: {
#     "intent": "TICKET" | "REVIEW" | "DISCUSSION",
#     "confidence": 0.0-1.0,
#     "persona_hint": "pm"|"architect"|"security"|None,
#     "topic": str|None,
#     "reasons": ["pattern: ...", "keyword: ..."]
# }
```

This field will be populated by intent_router_node before extraction.
  </action>
  <verify>`python -c "from src.schemas.state import AgentState; print('OK')"`</verify>
  <done>AgentState has intent_result field with documented structure</done>
</task>

<task type="auto">
  <name>Task 3: Integrate IntentRouter as graph entry point</name>
  <files>src/graph/graph.py</files>
  <action>
Modify graph to add intent_router as new entry point:

1. Import: `from src.graph.intent import intent_router_node`

2. Add node: `workflow.add_node("intent_router", intent_router_node)`

3. Change entry point: `workflow.set_entry_point("intent_router")`

4. Add conditional edge from intent_router:
```python
def route_after_intent(state: AgentState) -> Literal["ticket_flow", "review_flow", "discussion_flow"]:
    """Route based on classified intent."""
    intent_result = state.get("intent_result", {})
    intent = intent_result.get("intent", "TICKET")

    if intent == "REVIEW":
        return "review_flow"
    elif intent == "DISCUSSION":
        return "discussion_flow"
    else:
        return "ticket_flow"

workflow.add_conditional_edges(
    "intent_router",
    route_after_intent,
    {
        "ticket_flow": "extraction",  # Existing flow
        "review_flow": END,           # Placeholder - Plan 02 adds review node
        "discussion_flow": END,       # Placeholder - Plan 03 adds discussion node
    }
)
```

Update docstring to reflect new flow:
```
Graph structure:
  START -> intent_router -> {ticket_flow | review_flow | discussion_flow}

  ticket_flow: extraction -> validation -> decision -> END
  review_flow: (Plan 02)
  discussion_flow: (Plan 03)
```

Keep existing extraction, validation, decision flow unchanged for ticket_flow path.
  </action>
  <verify>Python syntax check: `python -m py_compile src/graph/graph.py`</verify>
  <done>Graph routes through intent_router first, then branches based on intent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile src/graph/intent.py` passes
- [ ] `python -m py_compile src/schemas/state.py` passes
- [ ] `python -m py_compile src/graph/graph.py` passes
- [ ] `python -c "from src.graph.graph import create_graph; g = create_graph(); print('Graph created')"` succeeds
</verification>

<success_criteria>

- IntentRouter node classifies messages into TICKET/REVIEW/DISCUSSION
- Explicit overrides detected without LLM call
- LLM used only for ambiguous cases
- Graph routes based on intent classification
- Logs show: intent, confidence, reasons
</success_criteria>

<output>
After completion, create `.planning/phases/13-intent-router/13-01-SUMMARY.md`
</output>
