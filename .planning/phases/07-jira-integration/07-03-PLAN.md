---
phase: 07-jira-integration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [src/skills/jira_search.py, src/skills/__init__.py, src/graph/nodes/decision.py]
autonomous: true
---

<objective>
Build jira_search skill as "last defense" before ticket creation - fast JQL search returning compact results for duplicate detection.

Purpose: Defensive layer against Jira clutter. Decision node can use search results to ask user about potential duplicates before creating new ticket.
Output: `jira_search()` skill with JQL query, compact results, integration with decision node.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-jira-integration/07-CONTEXT.md
@.planning/phases/07-jira-integration/07-01-SUMMARY.md

@src/jira/client.py
@src/jira/types.py
@src/graph/nodes/decision.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement jira_search skill</name>
  <files>src/skills/jira_search.py, src/skills/__init__.py</files>
  <action>
Create jira_search skill for fast duplicate detection:

```python
@dataclass
class JiraSearchResult:
    issues: list[JiraIssue]
    total_count: int
    query: str  # JQL used (for logging/debugging)

async def jira_search(
    query: str,
    project: Optional[str] = None,
    limit: int = 5,
    jira_service: JiraService,
) -> JiraSearchResult:
```

**Implementation:**

1. **Build JQL query:**
   ```python
   jql_parts = [f'text ~ "{query}"']  # Search in summary, description
   if project:
       jql_parts.append(f'project = "{project}"')
   # Exclude closed/done tickets
   jql_parts.append('status NOT IN (Done, Closed, Resolved)')
   jql = ' AND '.join(jql_parts)
   ```

2. **Execute search:**
   ```python
   issues = await jira_service.search_issues(jql, limit=limit)
   return JiraSearchResult(
       issues=issues,
       total_count=len(issues),
       query=jql,
   )
   ```

Also add convenience function:

```python
async def search_similar_to_draft(
    draft: TicketDraft,
    jira_service: JiraService,
    limit: int = 5,
) -> JiraSearchResult:
    """Search for tickets similar to draft title."""
    return await jira_search(
        query=draft.title,
        project=draft.epic_id.split('-')[0] if draft.epic_id else None,
        limit=limit,
        jira_service=jira_service,
    )
```

Fast mode only - no LLM semantic comparison (that's for later).
  </action>
  <verify>python -c "from src.skills.jira_search import jira_search, search_similar_to_draft; print('ok')"</verify>
  <done>jira_search skill with JQL query, compact results</done>
</task>

<task type="auto">
  <name>Task 2: Add potential duplicates to decision flow</name>
  <files>src/graph/nodes/decision.py</files>
  <action>
Update decision node to check for potential duplicates before PREVIEW:

1. **Add duplicate detection to decision_node:**
   ```python
   # Before showing PREVIEW, search for similar tickets
   if is_valid and not conflicts:
       # Check for potential duplicates
       similar = await search_similar_to_draft(draft, jira_service)
       if similar.total_count > 0:
           # Include duplicates in decision result
           return {
               "step_count": step_count + 1,
               "phase": AgentPhase.AWAITING_USER,
               "decision_result": DecisionResult(
                   action="preview",
                   reason="Draft meets requirements. Found potential duplicates.",
                   potential_duplicates=[
                       {"key": i.key, "summary": i.summary, "url": i.url}
                       for i in similar.issues[:3]  # Max 3 shown
                   ],
               ).model_dump(),
           }
   ```

2. **Update DecisionResult model:**
   ```python
   class DecisionResult(BaseModel):
       action: Literal["ask", "preview", "ready_to_create"]
       questions: list[str] = Field(default_factory=list)
       reason: str = ""
       potential_duplicates: list[dict] = Field(default_factory=list)  # NEW
   ```

The preview will show duplicates, user decides whether to proceed or link to existing.
  </action>
  <verify>python -c "from src.graph.nodes.decision import DecisionResult; print(DecisionResult.model_fields.keys())"</verify>
  <done>Decision node checks for duplicates before preview, includes in result</done>
</task>

<task type="auto">
  <name>Task 3: Show duplicates in preview UI</name>
  <files>src/slack/blocks.py</files>
  <action>
Update build_draft_preview_blocks_with_hash to show potential duplicates:

```python
def build_draft_preview_blocks_with_hash(
    draft: TicketDraft,
    session_id: str,
    draft_hash: str,
    potential_duplicates: list[dict] = None,  # NEW parameter
) -> list[dict]:
```

If potential_duplicates is not empty, add section before approval buttons:

```python
if potential_duplicates:
    blocks.append({"type": "divider"})
    blocks.append({
        "type": "section",
        "text": {
            "type": "mrkdwn",
            "text": "*Potential duplicates found:*"
        }
    })
    for dup in potential_duplicates[:3]:
        blocks.append({
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"â€¢ <{dup['url']}|{dup['key']}>: {dup['summary'][:50]}..."
            }
        })
    blocks.append({
        "type": "context",
        "elements": [{
            "type": "mrkdwn",
            "text": "_Review these before creating a new ticket_"
        }]
    })
```

User sees duplicates, can click to check, then decide whether to approve new ticket.
  </action>
  <verify>python -c "from src.slack.blocks import build_draft_preview_blocks_with_hash; print('ok')"</verify>
  <done>Preview shows potential duplicates with links before approval buttons</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.skills.jira_search import jira_search, JiraSearchResult"` succeeds
- [ ] `python -c "from src.skills import jira_search, search_similar_to_draft"` succeeds
- [ ] DecisionResult has potential_duplicates field
- [ ] Preview blocks show duplicates when present
</verification>

<success_criteria>

- jira_search returns fast JQL results
- search_similar_to_draft convenience function works with draft
- Decision node checks for duplicates before preview
- Preview UI shows potential duplicates with links
- User can review duplicates before approving new ticket
</success_criteria>

<output>
After completion, create `.planning/phases/07-jira-integration/07-03-SUMMARY.md`
</output>
