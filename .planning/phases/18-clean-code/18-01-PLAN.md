---
phase: 18-clean-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/handlers.py
  - src/slack/handlers/__init__.py
  - src/slack/handlers/core.py
  - src/slack/handlers/dispatch.py
  - src/slack/handlers/draft.py
  - src/slack/handlers/duplicates.py
  - src/slack/handlers/commands.py
  - src/slack/handlers/onboarding.py
  - src/slack/handlers/review.py
  - src/slack/handlers/misc.py
  - src/slack/bot.py
autonomous: true
---

<objective>
Split handlers.py (3193 lines) into logical modules under src/slack/handlers/.

Purpose: The current handlers.py is 5x over the 600-line limit. It contains distinct handler groups that can be cleanly separated into focused modules.

Output:
- 8 new files under src/slack/handlers/
- Each file under 500 lines with clear responsibility
- Re-exports in __init__.py for backward compatibility
- Updated imports in bot.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-clean-code/18-CONTEXT.md
@src/slack/handlers.py
@src/slack/bot.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create handlers/ package structure</name>
  <files>src/slack/handlers/__init__.py, src/slack/handlers/core.py</files>
  <action>
1. Create directory: `src/slack/handlers/`

2. Create `src/slack/handlers/core.py` with:
   - Module docstring explaining purpose
   - Imports needed
   - Move these functions from handlers.py:
     - `_get_background_loop()` (lines ~67-83)
     - `_run_async()` (lines ~85-94)
     - `handle_app_mention()` (lines ~96-127)
     - `_build_conversation_context()` (lines ~128-207)
     - `_process_mention()` (lines ~208-254)
     - `_check_persona_switch()` (lines ~255-304)
     - Global variables: `_background_loop`, `_loop_thread`

3. Create `src/slack/handlers/__init__.py` with:
```python
"""Slack event and action handlers.

This package contains all Slack handlers split by responsibility:
- core: App mention, message events, background loop
- dispatch: Result dispatch, content extraction
- draft: Draft approval, rejection, editing
- duplicates: Duplicate handling actions
- commands: /maro, /persona, /jira, /help commands
- onboarding: Channel join, hints, help examples
- review: Review-to-ticket, scope gate
- misc: Epic selection, contradictions, context merge
"""

from src.slack.handlers.core import (
    handle_app_mention,
    handle_message,
)

# More imports added as modules are created
```
  </action>
  <verify>python -c "from src.slack.handlers.core import handle_app_mention; print('OK')"</verify>
  <done>core.py created with main event handlers, package initialized</done>
</task>

<task type="auto">
  <name>Task 2: Create dispatch.py with result dispatching logic</name>
  <files>src/slack/handlers/dispatch.py</files>
  <action>
Create `src/slack/handlers/dispatch.py` with:
- Module docstring
- Move these functions from handlers.py:
  - `_extract_update_content()` (lines ~305-327)
  - `_extract_comment_content()` (lines ~328-346)
  - `_dispatch_result()` (lines ~347-784)
  - `_update_listening_context()` (lines ~785-853)
  - Prompts: `UPDATE_EXTRACTION_PROMPT`, `COMMENT_EXTRACTION_PROMPT`, `DECISION_EXTRACTION_PROMPT`

Note: `_dispatch_result()` is ~437 lines. This is acceptable for a single complex function but ensure it has section comments for each action type.

Import this from core.py since `_process_mention` calls `_dispatch_result`.
  </action>
  <verify>python -c "from src.slack.handlers.dispatch import _dispatch_result; print('OK')"</verify>
  <done>dispatch.py created with result dispatching logic</done>
</task>

<task type="auto">
  <name>Task 3: Create draft.py with approval/rejection handlers</name>
  <files>src/slack/handlers/draft.py</files>
  <action>
Create `src/slack/handlers/draft.py` with:
- Module docstring: "Draft approval, rejection, and editing handlers."
- Move these functions:
  - `handle_approve_draft()` (lines ~1353-1361)
  - `_handle_approve_draft_async()` (lines ~1362-1620)
  - `_post_error_actions()` (lines ~1621-1686)
  - `_update_preview_to_created()` (lines ~1687-1784)
  - `_build_approved_preview_blocks()` (lines ~1785-1861)
  - `handle_reject_draft()` (lines ~1862-1872)
  - `_handle_reject_draft_async()` (lines ~1873-1957)
  - `handle_edit_draft_submit()` (lines ~1958-1966)
  - `_handle_edit_draft_submit_async()` (lines ~1967-2090)
  - `_build_rejected_preview_blocks()` (lines ~2091-2149)

Update __init__.py to export:
```python
from src.slack.handlers.draft import (
    handle_approve_draft,
    handle_reject_draft,
    handle_edit_draft_submit,
)
```
  </action>
  <verify>python -c "from src.slack.handlers.draft import handle_approve_draft; print('OK')"</verify>
  <done>draft.py created with approval/rejection handlers</done>
</task>

<task type="auto">
  <name>Task 4: Create duplicates.py with duplicate handling</name>
  <files>src/slack/handlers/duplicates.py</files>
  <action>
Create `src/slack/handlers/duplicates.py` with:
- Module docstring: "Duplicate ticket handling - link, create anyway, show more."
- Move these functions:
  - `handle_link_duplicate()` + `_handle_link_duplicate_async()` (lines ~2460-2553)
  - `handle_create_anyway()` + `_handle_create_anyway_async()` (lines ~2554-2654)
  - `handle_add_to_duplicate()` + `_handle_add_to_duplicate_async()` (lines ~2655-2699)
  - `handle_show_more_duplicates()` + `_handle_show_more_duplicates_async()` (lines ~2700-2784)
  - `handle_modal_link_duplicate()` + `_handle_modal_link_duplicate_async()` (lines ~2785-2857)
  - `handle_modal_create_anyway()` + `_handle_modal_create_anyway_async()` (lines ~2858-2944)
  - `handle_merge_context()` (lines ~1226-1255)
  - `handle_ignore_dedup()` (lines ~1256-1273)

Update __init__.py exports.
  </action>
  <verify>python -c "from src.slack.handlers.duplicates import handle_link_duplicate; print('OK')"</verify>
  <done>duplicates.py created with duplicate handling</done>
</task>

<task type="auto">
  <name>Task 5: Create commands.py with slash command handlers</name>
  <files>src/slack/handlers/commands.py</files>
  <action>
Create `src/slack/handlers/commands.py` with:
- Module docstring: "Slash command handlers: /maro, /persona, /jira, /help."
- Move these functions:
  - `handle_maro_command()` + `_handle_maro_command_async()` (lines ~2150-2196)
  - `_handle_maro_enable()` (lines ~2197-2232)
  - `_handle_maro_disable()` (lines ~2233-2268)
  - `_handle_maro_status()` (lines ~2269-2323)
  - `_handle_maro_help()` (lines ~2324-2338)
  - `handle_persona_command()` + `_handle_persona_command_async()` (lines ~1021-1124)
  - `handle_jira_command()` (lines ~966-1020)
  - `handle_help_command()` (lines ~956-965)

Update __init__.py exports.
  </action>
  <verify>python -c "from src.slack.handlers.commands import handle_maro_command; print('OK')"</verify>
  <done>commands.py created with slash command handlers</done>
</task>

<task type="auto">
  <name>Task 6: Create remaining handler modules and update bot.py</name>
  <files>src/slack/handlers/onboarding.py, src/slack/handlers/review.py, src/slack/handlers/misc.py, src/slack/bot.py</files>
  <action>
1. Create `src/slack/handlers/onboarding.py`:
   - `handle_member_joined_channel()` + `_handle_channel_join_async()` (lines ~2945-3050)
   - `handle_hint_selection()` + `_handle_hint_selection_async()` (lines ~2339-2412)
   - `handle_help_example()` (lines ~2413-2459)

2. Create `src/slack/handlers/review.py`:
   - `handle_review_to_ticket()` (lines ~3051-3138)
   - `handle_scope_gate_submit()` + `_handle_scope_gate_submit_async()` (lines ~3139-end)

3. Create `src/slack/handlers/misc.py`:
   - `handle_epic_selection()` + related (lines ~1125-1225)
   - `handle_contradiction_conflict/override/both()` (lines ~1274-1352)
   - `handle_message()` + `_process_thread_message()` (lines ~854-955)

4. Update `src/slack/handlers/__init__.py` with all exports:
```python
"""Slack event and action handlers."""

from src.slack.handlers.core import handle_app_mention
from src.slack.handlers.misc import handle_message
from src.slack.handlers.commands import (
    handle_maro_command,
    handle_persona_command,
    handle_jira_command,
    handle_help_command,
)
from src.slack.handlers.draft import (
    handle_approve_draft,
    handle_reject_draft,
    handle_edit_draft_submit,
)
from src.slack.handlers.duplicates import (
    handle_link_duplicate,
    handle_create_anyway,
    handle_add_to_duplicate,
    handle_show_more_duplicates,
    handle_modal_link_duplicate,
    handle_modal_create_anyway,
    handle_merge_context,
    handle_ignore_dedup,
)
from src.slack.handlers.onboarding import (
    handle_member_joined_channel,
    handle_hint_selection,
    handle_help_example,
)
from src.slack.handlers.review import (
    handle_review_to_ticket,
    handle_scope_gate_submit,
)
from src.slack.handlers.misc import (
    handle_epic_selection,
    handle_epic_selection_sync,
    handle_contradiction_conflict,
    handle_contradiction_override,
    handle_contradiction_both,
)

__all__ = [
    # Core
    "handle_app_mention",
    "handle_message",
    # Commands
    "handle_maro_command",
    "handle_persona_command",
    "handle_jira_command",
    "handle_help_command",
    # Draft
    "handle_approve_draft",
    "handle_reject_draft",
    "handle_edit_draft_submit",
    # Duplicates
    "handle_link_duplicate",
    "handle_create_anyway",
    "handle_add_to_duplicate",
    "handle_show_more_duplicates",
    "handle_modal_link_duplicate",
    "handle_modal_create_anyway",
    "handle_merge_context",
    "handle_ignore_dedup",
    # Onboarding
    "handle_member_joined_channel",
    "handle_hint_selection",
    "handle_help_example",
    # Review
    "handle_review_to_ticket",
    "handle_scope_gate_submit",
    # Misc
    "handle_epic_selection",
    "handle_epic_selection_sync",
    "handle_contradiction_conflict",
    "handle_contradiction_override",
    "handle_contradiction_both",
]
```

5. Update `src/slack/bot.py` imports:
   - Change: `from src.slack.handlers import ...`
   - To: `from src.slack.handlers import ...` (same, but from package)
   - Or if needed: `from src.slack.handlers.core import handle_app_mention`, etc.

6. Delete the original `src/slack/handlers.py` after verifying all imports work.
  </action>
  <verify>python -c "from src.slack.handlers import handle_app_mention, handle_message, handle_maro_command; print('OK')"</verify>
  <done>All handler modules created, bot.py updated, original handlers.py removed</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.slack.handlers import *; print('OK')"` works
- [ ] `python -c "from src.slack.bot import create_app; print('OK')"` works
- [ ] No file in src/slack/handlers/ exceeds 600 lines
- [ ] Original handlers.py is deleted
- [ ] `find src/slack/handlers -name "*.py" -exec wc -l {} \;` shows all files under 600 lines
</verification>

<success_criteria>
- handlers.py split into 8 logical modules
- All modules under 500 lines
- All imports work correctly
- Bot can still be created and run
- No functionality changed
</success_criteria>

<output>
After completion, create `.planning/phases/18-clean-code/18-01-SUMMARY.md`
</output>
