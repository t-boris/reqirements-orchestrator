# Plan: 10-03 Production deployment scripts

## Objective

Create deploy.sh script that builds image via Cloud Build, pushes to Artifact Registry, and restarts containers on GCE VM via SSH.

## Execution Context

**Phase**: 10-deployment
**Wave**: 2 (depends on 10-01 Dockerfile existing)
**Estimated scope**: Small (shell script + Cloud Build config)

**Files to create**:
- `deploy.sh` - One-command deployment script
- `cloudbuild.yaml` - Cloud Build configuration

**References**:
- 10-CONTEXT.md deployment flow
- Existing `deploy/setup-vm.sh` from main branch

## Context

### Deploy Flow (from 10-CONTEXT.md)
```bash
# From local machine
./deploy.sh

# Script does:
# 1. gcloud builds submit --tag gcr.io/PROJECT/maro
# 2. gcloud compute ssh VM -- 'docker-compose pull && docker-compose up -d'
```

### Prerequisites (user has already set up)
- GCE VM exists and is running
- gcloud CLI authenticated
- Artifact Registry repository exists
- .env file configured on VM at /opt/maro/.env

### Environment Variables for Script
- `GCP_PROJECT` - GCP project ID
- `GCE_INSTANCE` - VM instance name
- `GCE_ZONE` - VM zone (default: us-central1-a)

## Tasks

### Task 1: Create cloudbuild.yaml
Cloud Build configuration for building and pushing to Artifact Registry.

```yaml
# cloudbuild.yaml
# =============================================================================
# Cloud Build configuration for MARO
# Builds Docker image and pushes to Artifact Registry
# =============================================================================

steps:
  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/maro:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/maro:latest'
      - '.'

# Push images to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/maro:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/maro:latest'

# Substitution defaults
substitutions:
  _REGION: us-central1
  _REPO: maro

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
```

### Task 2: Create deploy.sh
One-command deployment script.

```bash
#!/bin/bash
# =============================================================================
# MARO Deployment Script
# Builds via Cloud Build and deploys to GCE VM
# =============================================================================

set -e

# -----------------------------------------------------------------------------
# Configuration (override via environment or .deploy.env)
# -----------------------------------------------------------------------------
if [ -f ".deploy.env" ]; then
    source .deploy.env
fi

GCP_PROJECT="${GCP_PROJECT:?Error: GCP_PROJECT not set}"
GCE_INSTANCE="${GCE_INSTANCE:?Error: GCE_INSTANCE not set}"
GCE_ZONE="${GCE_ZONE:-us-central1-a}"
REGION="${REGION:-us-central1}"
REPO="${REPO:-maro}"

IMAGE="${REGION}-docker.pkg.dev/${GCP_PROJECT}/${REPO}/maro:latest"

echo "=========================================="
echo "MARO Deployment"
echo "=========================================="
echo "Project:  ${GCP_PROJECT}"
echo "Instance: ${GCE_INSTANCE}"
echo "Zone:     ${GCE_ZONE}"
echo "Image:    ${IMAGE}"
echo "=========================================="
echo ""

# -----------------------------------------------------------------------------
# Step 1: Build and push via Cloud Build
# -----------------------------------------------------------------------------
echo "Step 1: Building image via Cloud Build..."
gcloud builds submit \
    --project="${GCP_PROJECT}" \
    --config=cloudbuild.yaml \
    --substitutions="_REGION=${REGION},_REPO=${REPO}" \
    .

echo ""
echo "✓ Image built and pushed to Artifact Registry"
echo ""

# -----------------------------------------------------------------------------
# Step 2: Deploy to VM via SSH
# -----------------------------------------------------------------------------
echo "Step 2: Deploying to VM..."

gcloud compute ssh "${GCE_INSTANCE}" \
    --project="${GCP_PROJECT}" \
    --zone="${GCE_ZONE}" \
    --command="cd /opt/maro && \
        docker-compose pull && \
        docker-compose up -d && \
        docker-compose ps"

echo ""
echo "=========================================="
echo "✓ Deployment complete!"
echo "=========================================="
echo ""
echo "Check status:"
echo "  gcloud compute ssh ${GCE_INSTANCE} --zone=${GCE_ZONE} --command='cd /opt/maro && docker-compose logs -f'"
echo ""
```

### Task 3: Create .deploy.env.example
Template for deployment configuration.

```bash
# .deploy.env.example
# Copy to .deploy.env and fill in your values

# GCP Project ID (required)
GCP_PROJECT=your-project-id

# GCE VM instance name (required)
GCE_INSTANCE=maro-vm

# GCE zone (default: us-central1-a)
GCE_ZONE=us-central1-a

# Artifact Registry region (default: us-central1)
REGION=us-central1

# Artifact Registry repository name (default: maro)
REPO=maro
```

### Task 4: Create VM setup reminder
Create `deploy/README.md` with VM setup instructions.

```markdown
# MARO Deployment

## Prerequisites

### 1. GCE VM Setup

```bash
# Create VM (if not exists)
gcloud compute instances create maro-vm \
    --project=YOUR_PROJECT \
    --zone=us-central1-a \
    --machine-type=e2-small \
    --image-family=debian-12 \
    --image-project=debian-cloud

# SSH into VM and run setup
gcloud compute ssh maro-vm --zone=us-central1-a
# Then run: curl -fsSL https://get.docker.com | sh
# Add user to docker group: sudo usermod -aG docker $USER
# Log out and back in
```

### 2. Artifact Registry Setup

```bash
# Create repository
gcloud artifacts repositories create maro \
    --project=YOUR_PROJECT \
    --repository-format=docker \
    --location=us-central1

# Configure Docker auth
gcloud auth configure-docker us-central1-docker.pkg.dev
```

### 3. VM Configuration

```bash
# On the VM
sudo mkdir -p /opt/maro
sudo chown $USER:$USER /opt/maro
cd /opt/maro

# Copy .env file (with your secrets)
# Copy docker-compose.yml
```

## Deployment

```bash
# From local machine
./deploy.sh
```

## Monitoring

```bash
# View logs
gcloud compute ssh maro-vm --command='cd /opt/maro && docker-compose logs -f bot'

# Check health
gcloud compute ssh maro-vm --command='curl -s localhost:8000/health'

# Restart services
gcloud compute ssh maro-vm --command='cd /opt/maro && docker-compose restart'
```
```

## Verification

```bash
# Check scripts exist and are executable
ls -la deploy.sh cloudbuild.yaml

# Validate cloudbuild.yaml syntax
gcloud builds submit --config=cloudbuild.yaml --no-source --dry-run 2>&1 || echo "Dry run not supported, syntax looks ok"

# Test deploy.sh help (should fail with missing env vars)
./deploy.sh 2>&1 | head -5
```

## Success Criteria

- [ ] `cloudbuild.yaml` defines build steps for Artifact Registry
- [ ] `deploy.sh` is executable and handles both build and SSH deploy
- [ ] `.deploy.env.example` documents required deployment configuration
- [ ] `deploy/README.md` provides VM setup instructions

## Output

Files created:
- `cloudbuild.yaml`
- `deploy.sh` (executable)
- `.deploy.env.example`
- `deploy/README.md`
