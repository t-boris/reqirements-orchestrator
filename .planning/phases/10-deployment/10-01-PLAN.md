# Plan: 10-01 Dockerfile and docker-compose

## Objective

Create production-ready Dockerfile and docker-compose.yml for Socket Mode Slack bot with PostgreSQL and health endpoint.

## Execution Context

**Phase**: 10-deployment
**Wave**: 1 (can run in parallel with nothing - first plan)
**Estimated scope**: Small (straightforward Docker config)

**Files to create/modify**:
- `Dockerfile` - Multi-stage build for Python 3.11, Socket Mode bot
- `docker-compose.yml` - Production-ready with Postgres, restart policies

**References**:
- Existing `src/slack/app.py` - Entry point (Socket Mode)
- Existing `pyproject.toml` - Dependencies
- Main branch Dockerfile/docker-compose - Patterns to adapt

## Context

### Current Application Structure
- Entry point: `src/slack/app.py` with `start_socket_mode()` blocking call
- No FastAPI/HTTP server - pure Socket Mode Slack bot
- Database: PostgreSQL via asyncpg
- LangGraph checkpointer uses Postgres
- Health endpoint needed for Docker healthcheck

### Key Differences from Main Branch
- Main branch had `src.api.main:app` (FastAPI) - doesn't exist
- Current app is Socket Mode bot (no HTTP server by default)
- Need to add minimal health endpoint for Docker healthcheck

### Production Requirements (from 10-CONTEXT.md)
- `restart: always` for 24/7 uptime
- Auto migrations on startup
- Health endpoint for Docker healthcheck
- Memory-constrained (e2-small ~2GB)

## Tasks

### Task 1: Create health server module
Create `src/health.py` with minimal HTTP health endpoint for Docker.

```python
# src/health.py
"""Minimal health server for Docker healthcheck."""

import asyncio
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading
import logging

logger = logging.getLogger(__name__)

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == "/health":
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            self.wfile.write(b'{"status":"healthy"}')
        else:
            self.send_response(404)
            self.end_headers()

    def log_message(self, format, *args):
        pass  # Suppress access logs

_server: HTTPServer | None = None
_thread: threading.Thread | None = None

def start_health_server(port: int = 8000):
    """Start health server in background thread."""
    global _server, _thread
    _server = HTTPServer(("0.0.0.0", port), HealthHandler)
    _thread = threading.Thread(target=_server.serve_forever, daemon=True)
    _thread.start()
    logger.info(f"Health server started on port {port}")

def stop_health_server():
    """Stop health server."""
    global _server
    if _server:
        _server.shutdown()
        _server = None
        logger.info("Health server stopped")
```

### Task 2: Create main entry point
Create `src/__main__.py` as the application entry point.

```python
# src/__main__.py
"""Main entry point for the Slack bot."""

import asyncio
import logging
import sys

from src.config import get_settings
from src.db.connection import init_pool, close_pool
from src.db.checkpointer import setup_checkpointer
from src.slack.app import get_slack_app, start_socket_mode
from src.slack.router import register_handlers
from src.health import start_health_server

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)
logger = logging.getLogger(__name__)


async def init_database():
    """Initialize database connection and run migrations."""
    logger.info("Initializing database...")
    await init_pool()
    await setup_checkpointer()
    logger.info("Database initialized")


def main():
    """Main entry point."""
    logger.info("Starting MARO bot...")

    # Initialize database
    asyncio.run(init_database())

    # Start health server for Docker healthcheck
    start_health_server(port=8000)

    # Initialize Slack app and register handlers
    app = get_slack_app()
    register_handlers(app)

    logger.info("MARO bot ready")

    # Start Socket Mode (blocking)
    start_socket_mode()


if __name__ == "__main__":
    main()
```

### Task 3: Create Dockerfile
Create production Dockerfile with multi-stage build.

```dockerfile
# Dockerfile
# =============================================================================
# MARO Slack Bot - Production Dockerfile
# Multi-stage build for optimized image size
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Builder
# -----------------------------------------------------------------------------
FROM python:3.11-slim as builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY pyproject.toml ./
RUN pip install --no-cache-dir build && \
    pip wheel --no-cache-dir --wheel-dir /wheels .

# -----------------------------------------------------------------------------
# Stage 2: Runtime
# -----------------------------------------------------------------------------
FROM python:3.11-slim as runtime

WORKDIR /app

# Install curl for healthcheck and create non-root user
RUN apt-get update && apt-get install -y --no-install-recommends curl \
    && rm -rf /var/lib/apt/lists/* \
    && useradd --create-home --shell /bin/bash maro

# Copy wheels from builder and install
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/*.whl && rm -rf /wheels

# Copy application code
COPY src/ ./src/
COPY personas/ ./personas/

# Set ownership
RUN chown -R maro:maro /app

USER maro

# Expose health port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Run the bot
CMD ["python", "-m", "src"]
```

### Task 4: Create docker-compose.yml
Create production docker-compose with restart policies.

```yaml
# docker-compose.yml
# =============================================================================
# MARO Production Docker Compose
# Optimized for e2-small VM (2GB RAM)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: maro-postgres
    restart: always
    environment:
      POSTGRES_USER: maro
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-maro_secure}
      POSTGRES_DB: maro
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maro"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M

  # ---------------------------------------------------------------------------
  # MARO Slack Bot
  # ---------------------------------------------------------------------------
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: maro-bot
    restart: always
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+asyncpg://maro:${POSTGRES_PASSWORD:-maro_secure}@postgres:5432/maro
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  postgres_data:
```

## Verification

```bash
# Build locally
docker-compose build

# Check image size
docker images | grep maro

# Start services
docker-compose up -d

# Verify health endpoint
curl http://localhost:8000/health

# Check logs
docker-compose logs -f bot
```

## Success Criteria

- [ ] `src/health.py` provides `/health` endpoint
- [ ] `src/__main__.py` initializes DB, health server, and Socket Mode
- [ ] `Dockerfile` builds successfully with multi-stage
- [ ] `docker-compose.yml` starts postgres and bot with restart: always
- [ ] Health endpoint responds at `http://localhost:8000/health`

## Output

Files created:
- `src/health.py`
- `src/__main__.py`
- `Dockerfile`
- `docker-compose.yml`
