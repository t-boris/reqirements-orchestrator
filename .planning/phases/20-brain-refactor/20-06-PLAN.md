---
phase: 20-brain-refactor
plan: 06
type: execute
wave: 3
depends_on: ["20-04", "20-05"]
files_modified:
  - src/graph/intent.py
  - src/slack/blocks/scope_gate.py
  - src/slack/handlers/scope_gate.py
autonomous: true
---

<objective>
Implement AMBIGUOUS intent with 3-button scope gate + "Remember for this thread" option.

Purpose: Remove "lean toward TICKET" bias. User decides intent when unclear.
Output: Scope gate UI, handlers, thread_default_intent persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-brain-refactor/20-CONTEXT.md
@.planning/phases/20-brain-refactor/20-04-SUMMARY.md
@src/graph/intent.py
@src/slack/blocks/ui.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Update intent classification to include AMBIGUOUS</name>
  <files>src/graph/intent.py</files>
  <action>
Update the LLM classification prompt to include AMBIGUOUS as an option:

1. In `_llm_classify`, update the prompt to include AMBIGUOUS:
```python
- AMBIGUOUS: User intent is unclear - could be either a ticket request or a review request. Use when message could reasonably go either way (e.g., "what do you think about microservices?", "we should probably do something about auth")
```

2. Remove the bias: Delete or comment out the line:
```python
# OLD: "If the user seems to want to work on something but it's unclear if they want a ticket, lean toward TICKET."
# NEW: "If the user's intent is unclear (could be ticket OR review), choose AMBIGUOUS."
```

3. Add AMBIGUOUS to the valid_intents list in `_llm_classify`.

4. The pattern matcher should NOT trigger AMBIGUOUS - that's only for LLM when it's genuinely unsure.

Key change: Instead of defaulting to TICKET when unsure, we now route to scope gate.
  </action>
  <verify>python -c "from src.graph.intent import classify_intent; print('OK')"</verify>
  <done>Intent classification includes AMBIGUOUS without TICKET bias</done>
</task>

<task type="auto">
  <name>Task 2: Create scope gate blocks</name>
  <files>src/slack/blocks/scope_gate.py</files>
  <action>
Create new file `src/slack/blocks/scope_gate.py`:

```python
"""Scope gate UI blocks for AMBIGUOUS intent.

3-button scope gate with "Remember for this thread" option.
"""
from typing import Optional


def build_scope_gate_blocks(
    message_preview: str,
    include_remember: bool = True,
) -> list[dict]:
    """Build scope gate blocks for AMBIGUOUS intent.

    Shows 3 buttons:
    - "Review" - Route to review flow
    - "Create ticket" - Route to ticket flow
    - "Not now" - Dismiss and stop

    Plus optional "Remember for this thread" checkbox.

    Args:
        message_preview: First ~50 chars of user message for context
        include_remember: Whether to include remember checkbox

    Returns:
        Slack blocks for scope gate
    """
    blocks = [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"I'm not sure what you'd like me to do with:\n> _{message_preview[:50]}{'...' if len(message_preview) > 50 else ''}_\n\nWhat would you like?",
            },
        },
        {
            "type": "actions",
            "elements": [
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Review / Analyze"},
                    "action_id": "scope_gate_review",
                    "style": "primary",
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Create Ticket"},
                    "action_id": "scope_gate_ticket",
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Not now"},
                    "action_id": "scope_gate_dismiss",
                },
            ],
        },
    ]

    if include_remember:
        blocks.append({
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "_Tip: You can select 'Remember' to set a default for this thread_",
            },
            "accessory": {
                "type": "checkboxes",
                "action_id": "scope_gate_remember",
                "options": [
                    {
                        "text": {"type": "mrkdwn", "text": "Remember for this thread"},
                        "value": "remember",
                    },
                ],
            },
        })

    return blocks


def build_scope_gate_dismissed_blocks() -> list[dict]:
    """Blocks shown after user selects 'Not now'."""
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "Got it. Just @ me when you're ready.",
            },
        },
    ]


def build_scope_gate_remembered_blocks(intent: str) -> list[dict]:
    """Blocks shown after user selects an option with 'Remember'."""
    intent_display = "Review" if intent == "review" else "Create Ticket"
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"Got it. I'll default to *{intent_display}* for this thread. You can use `/maro forget` to clear this.",
            },
        },
    ]
```
  </action>
  <verify>python -c "from src.slack.blocks.scope_gate import build_scope_gate_blocks; print('OK')"</verify>
  <done>Scope gate blocks created with 3 buttons + remember checkbox</done>
</task>

<task type="auto">
  <name>Task 3: Create scope gate handlers</name>
  <files>src/slack/handlers/scope_gate.py</files>
  <action>
Create new file `src/slack/handlers/scope_gate.py`:

```python
"""Handlers for scope gate interactions.

Handles the 3-button scope gate for AMBIGUOUS intent:
- Review: Route to review flow
- Create ticket: Route to ticket flow
- Not now: Dismiss

Plus "Remember for this thread" checkbox state.
"""
import logging
from datetime import datetime, timedelta

from slack_sdk.web import WebClient

from src.schemas.state import UserIntent, PendingAction, WorkflowStep
from src.slack.blocks.scope_gate import (
    build_scope_gate_dismissed_blocks,
    build_scope_gate_remembered_blocks,
)

logger = logging.getLogger(__name__)

# How long "Remember" lasts (2 hours)
REMEMBER_TTL_HOURS = 2


def handle_scope_gate_review(body: dict, client: WebClient):
    """Handle 'Review' button click on scope gate.

    Routes to review flow. If 'Remember' was checked, stores thread default.
    """
    channel = body.get("channel", {}).get("id")
    thread_ts = body.get("message", {}).get("thread_ts") or body.get("message", {}).get("ts")
    user_id = body.get("user", {}).get("id")

    # Check if remember was selected
    remember = _check_remember_selected(body)

    # Update original message to show selection
    message_ts = body.get("message", {}).get("ts")
    if remember:
        blocks = build_scope_gate_remembered_blocks("review")
    else:
        blocks = [{"type": "section", "text": {"type": "mrkdwn", "text": "Routing to review..."}}]

    client.chat_update(
        channel=channel,
        ts=message_ts,
        blocks=blocks,
        text="Routing to review...",
    )

    # Store thread default if remember selected
    if remember:
        _store_thread_default(channel, thread_ts, UserIntent.REVIEW)

    # Re-route to review flow with original message
    _route_to_flow(body, client, UserIntent.REVIEW)


def handle_scope_gate_ticket(body: dict, client: WebClient):
    """Handle 'Create ticket' button click on scope gate.

    Routes to ticket flow. If 'Remember' was checked, stores thread default.
    """
    channel = body.get("channel", {}).get("id")
    thread_ts = body.get("message", {}).get("thread_ts") or body.get("message", {}).get("ts")
    message_ts = body.get("message", {}).get("ts")

    remember = _check_remember_selected(body)

    if remember:
        blocks = build_scope_gate_remembered_blocks("ticket")
    else:
        blocks = [{"type": "section", "text": {"type": "mrkdwn", "text": "Creating ticket..."}}]

    client.chat_update(
        channel=channel,
        ts=message_ts,
        blocks=blocks,
        text="Creating ticket...",
    )

    if remember:
        _store_thread_default(channel, thread_ts, UserIntent.TICKET)

    _route_to_flow(body, client, UserIntent.TICKET)


def handle_scope_gate_dismiss(body: dict, client: WebClient):
    """Handle 'Not now' button click on scope gate.

    Clears pending_action and stops cycle.
    """
    channel = body.get("channel", {}).get("id")
    message_ts = body.get("message", {}).get("ts")

    blocks = build_scope_gate_dismissed_blocks()
    client.chat_update(
        channel=channel,
        ts=message_ts,
        blocks=blocks,
        text="Got it. Just @ me when you're ready.",
    )

    # Clear any pending action in state
    # This happens via state update in the main handler


def _check_remember_selected(body: dict) -> bool:
    """Check if 'Remember' checkbox was selected.

    The checkbox state is in body.state.values.
    """
    state = body.get("state", {})
    values = state.get("values", {})

    for block_id, block_values in values.items():
        for action_id, action_value in block_values.items():
            if action_id == "scope_gate_remember":
                selected_options = action_value.get("selected_options", [])
                return len(selected_options) > 0

    return False


def _store_thread_default(channel_id: str, thread_ts: str, intent: UserIntent):
    """Store thread default intent with 2h expiry.

    TODO: This will be integrated with state persistence in 20-04.
    For now, log intent for debugging.
    """
    expires_at = datetime.utcnow() + timedelta(hours=REMEMBER_TTL_HOURS)
    logger.info(
        f"Storing thread default: {intent.value} for {channel_id}/{thread_ts}, "
        f"expires {expires_at.isoformat()}"
    )
    # State update will be handled by graph runner


def _route_to_flow(body: dict, client: WebClient, intent: UserIntent):
    """Re-route original message to the selected flow.

    TODO: This needs integration with graph runner.
    For now, log the routing decision.
    """
    logger.info(f"Routing to {intent.value} flow after scope gate selection")
    # Integration with graph runner in a later plan
```

Register handlers in `src/slack/app.py` or `src/slack/handlers/__init__.py`.
  </action>
  <verify>python -c "from src.slack.handlers.scope_gate import handle_scope_gate_review; print('OK')"</verify>
  <done>Scope gate handlers created for review/ticket/dismiss buttons</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Intent classifier includes AMBIGUOUS without TICKET bias
- [ ] Scope gate blocks show 3 buttons + remember checkbox
- [ ] Scope gate handlers update message and store thread default
- [ ] `python -m pytest tests/ -x --tb=short` passes
</verification>

<success_criteria>
- AMBIGUOUS intent triggers scope gate instead of defaulting to TICKET
- Scope gate shows 3 options: Review, Create ticket, Not now
- "Remember for this thread" checkbox works
- Thread default stored with 2h expiry
</success_criteria>

<output>
After completion, create `.planning/phases/20-brain-refactor/20-06-SUMMARY.md`
</output>
