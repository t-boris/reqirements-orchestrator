---
phase: 20-brain-refactor
plan: 12
type: execute
wave: 6
depends_on: ["20-09", "20-10"]
files_modified:
  - src/graph/intent.py
  - src/graph/graph.py
  - src/slack/handlers/core.py
autonomous: true
---

<objective>
Integration plan: Wire event routing, simplify intent router, update graph flow.

Purpose: Connect all Phase 20 components into working system.
Output: Event-first routing in handlers, simplified intent types, updated graph.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-brain-refactor/20-CONTEXT.md
@src/graph/intent.py
@src/graph/graph.py
@src/slack/handlers/core.py
@src/slack/event_router.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Simplify IntentType in intent.py</name>
  <files>src/graph/intent.py</files>
  <action>
Simplify IntentType to only contain pure user intents. Remove workflow events:

Current IntentType (to be modified):
```python
class IntentType(str, Enum):
    TICKET = "TICKET"
    REVIEW = "REVIEW"
    DISCUSSION = "DISCUSSION"
    TICKET_ACTION = "TICKET_ACTION"  # REMOVE - becomes PendingAction
    DECISION_APPROVAL = "DECISION_APPROVAL"  # REMOVE - becomes PendingAction
    REVIEW_CONTINUATION = "REVIEW_CONTINUATION"  # REMOVE - detected via review_context
```

New simplified IntentType:
```python
class IntentType(str, Enum):
    """Pure user intent - what user wants (not workflow state)."""
    TICKET = "TICKET"
    REVIEW = "REVIEW"
    DISCUSSION = "DISCUSSION"
    META = "META"
    AMBIGUOUS = "AMBIGUOUS"
```

Update classify_intent_patterns to return AMBIGUOUS for uncertain cases instead of defaulting to TICKET.

Update LLM prompt to remove TICKET bias:
- OLD: "If unclear, lean toward TICKET"
- NEW: "If unclear, return AMBIGUOUS"

Keep the pattern matching for explicit patterns (create ticket, review, etc.)
but route ambiguous cases to AMBIGUOUS.
  </action>
  <verify>python -c "from src.graph.intent import IntentType; assert 'AMBIGUOUS' in [e.value for e in IntentType]; print('OK')"</verify>
  <done>IntentType simplified to 5 pure intents, AMBIGUOUS replaces TICKET bias</done>
</task>

<task type="auto">
  <name>Task 2: Update graph.py route_after_intent</name>
  <files>src/graph/graph.py</files>
  <action>
Update route_after_intent to handle new routing:

```python
def route_after_intent(state: AgentState) -> str:
    """Route based on classified intent.

    Priority (from 20-CONTEXT.md):
    1. WorkflowEvent - handled before graph (event_router)
    2. PendingAction - handled before graph (event_router)
    3. Thread default intent - check and use
    4. Classified intent - route to flow

    Note: TICKET_ACTION, DECISION_APPROVAL, REVIEW_CONTINUATION
    are now PendingAction values, not intents.
    """
    intent_result = state.get("intent_result", {})
    intent = intent_result.get("intent", "TICKET")

    # Check for thread default (set by "Remember for this thread")
    thread_default = state.get("thread_default_intent")
    if thread_default and intent == "AMBIGUOUS":
        intent = thread_default

    if intent == "REVIEW":
        return "review_flow"
    elif intent == "DISCUSSION":
        return "discussion_flow"
    elif intent == "META":
        return "discussion_flow"  # Meta questions get brief responses
    elif intent == "AMBIGUOUS":
        return "scope_gate_flow"  # New: show scope gate
    else:  # TICKET
        return "ticket_flow"
```

Add scope_gate node to graph:
```python
workflow.add_node("scope_gate", scope_gate_node)
```

Add routing to scope_gate:
```python
workflow.add_conditional_edges(
    "intent_router",
    route_after_intent,
    {
        "ticket_flow": "extraction",
        "review_flow": "review",
        "discussion_flow": "discussion",
        "scope_gate_flow": "scope_gate",
    }
)

workflow.add_edge("scope_gate", END)  # Scope gate shows UI and waits
```
  </action>
  <verify>python -c "from src.graph.graph import create_graph; g = create_graph(); print('OK')"</verify>
  <done>Graph routes AMBIGUOUS to scope_gate, respects thread_default_intent</done>
</task>

<task type="auto">
  <name>Task 3: Integrate event router in handlers/core.py</name>
  <files>src/slack/handlers/core.py</files>
  <action>
Update _process_mention to use event router before intent classification:

```python
async def _process_mention(
    identity: SessionIdentity,
    text: str,
    user: str,
    client: WebClient,
    thread_ts: str,
    channel: str,
):
    """Process app mention with event-first routing."""
    from src.slack.event_router import route_event, RouteResult
    from src.db import get_connection, EventStore

    # Get current state
    runner = await get_runner()
    state = await runner.get_state(identity)

    # Event routing (for button clicks, slash commands)
    # For @mentions, this will return INTENT_CLASSIFY
    async with get_connection() as conn:
        event_store = EventStore(conn)
        await event_store.ensure_table()

        routing = await route_event(
            body={"type": "message", "text": text},  # Simplified for mentions
            team_id=identity.team_id,
            state=state,
            event_store=event_store,
        )

    if routing.result == RouteResult.DUPLICATE:
        logger.info("Duplicate event, skipping")
        return

    if routing.result == RouteResult.STALE_UI:
        client.chat_postMessage(
            channel=channel,
            thread_ts=thread_ts,
            text=routing.error_message,
        )
        return

    if routing.result == RouteResult.CONTINUATION:
        # Handle pending action continuation
        await _handle_continuation(
            identity, routing.pending_action, state, client, thread_ts, channel
        )
        return

    # Default: run graph with intent classification
    await _run_graph_with_intent(identity, text, user, client, thread_ts, channel)
```

This integrates event-first routing from 20-05 into the main handler flow.
  </action>
  <verify>python -c "from src.slack.handlers.core import handle_app_mention; print('OK')"</verify>
  <done>Event router integrated in handlers/core.py</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] IntentType has 5 values: TICKET, REVIEW, DISCUSSION, META, AMBIGUOUS
- [ ] Graph routes AMBIGUOUS to scope_gate
- [ ] Event router integrated in handler flow
- [ ] Thread default intent respected when routing
- [ ] `python -m pytest tests/ -x --tb=short` passes
</verification>

<success_criteria>
- IntentType simplified (no workflow events)
- AMBIGUOUS routes to scope gate (not default to TICKET)
- Event-first routing works in handlers
- All Phase 20 components integrated
</success_criteria>

<output>
After completion, create `.planning/phases/20-brain-refactor/20-12-SUMMARY.md`
</output>
