---
phase: 20-brain-refactor
plan: 09
type: execute
wave: 5
depends_on: ["20-07", "20-08"]
files_modified:
  - src/schemas/state.py
  - src/graph/nodes/multi_ticket.py
  - src/slack/blocks/multi_ticket.py
autonomous: true
---

<objective>
Implement multi-ticket flow foundation: Epic + stories data model, quantity/size safety latches.

Purpose: Support "Create epic with 5 stories" without hacking intent types.
Output: MultiTicketState, safety latch functions, preview blocks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-brain-refactor/20-CONTEXT.md
@src/schemas/state.py
@src/schemas/draft.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add MultiTicketState to state.py</name>
  <files>src/schemas/state.py</files>
  <action>
Add MultiTicketState TypedDict for multi-ticket workflow:

```python
class MultiTicketItem(TypedDict):
    """Single item in multi-ticket batch (epic or story)."""
    id: str  # Unique ID within batch
    type: Literal["epic", "story"]
    title: str
    description: str
    parent_id: Optional[str]  # For stories, points to epic ID


class MultiTicketState(TypedDict):
    """State for multi-ticket creation flow.

    Supports Epic + linked stories (not subtasks by default).
    """
    items: list[MultiTicketItem]  # All items in batch
    epic_id: Optional[str]  # ID of epic item (if present)
    total_chars: int  # Total size for size latch
    confirmed_quantity: bool  # User confirmed >3 items
    confirmed_size: bool  # User confirmed large batch
    created_keys: list[str]  # Jira keys after creation
```

Add to AgentState:
```python
    # Multi-ticket state (Phase 20)
    multi_ticket_state: Optional[MultiTicketState]
```

Constants for safety latches:
```python
# Safety latch thresholds
MULTI_TICKET_QUANTITY_THRESHOLD = 3  # >3 items requires confirmation
MULTI_TICKET_SIZE_THRESHOLD = 10000  # >10k chars requires confirmation
```
  </action>
  <verify>python -c "from src.schemas.state import MultiTicketState, MultiTicketItem; print('OK')"</verify>
  <done>MultiTicketState and MultiTicketItem TypedDicts exist</done>
</task>

<task type="auto">
  <name>Task 2: Create multi-ticket extraction node</name>
  <files>src/graph/nodes/multi_ticket.py</files>
  <action>
Create new file `src/graph/nodes/multi_ticket.py`:

```python
"""Multi-ticket extraction and workflow nodes.

Handles "Create epic with N stories" requests.
Includes safety latches for quantity (>3) and size (>10k chars).
"""
import logging
import uuid
from typing import Optional

from src.schemas.state import (
    MultiTicketState,
    MultiTicketItem,
    PendingAction,
    WorkflowStep,
    MULTI_TICKET_QUANTITY_THRESHOLD,
    MULTI_TICKET_SIZE_THRESHOLD,
)

logger = logging.getLogger(__name__)


MULTI_TICKET_EXTRACTION_PROMPT = '''Extract an epic and its stories from this request.

User request: {message}

Context (if available):
{context}

Return JSON:
{{
    "epic": {{
        "title": "Epic title",
        "description": "Epic description"
    }},
    "stories": [
        {{"title": "Story 1 title", "description": "Story 1 description"}},
        {{"title": "Story 2 title", "description": "Story 2 description"}}
    ]
}}

Be concise. Each story should be a distinct, implementable unit.
'''


async def extract_multi_ticket(state: dict) -> dict:
    """Extract epic + stories from user request.

    Applies safety latches:
    - >3 items: requires quantity confirmation
    - >10k chars: requires size confirmation (split into batches?)
    """
    from langchain_core.messages import HumanMessage
    from src.llm import get_llm
    import json

    # Get user message
    messages = state.get("messages", [])
    user_message = ""
    for msg in reversed(messages):
        if isinstance(msg, HumanMessage):
            user_message = msg.content
            break

    context = state.get("conversation_context", {})
    context_str = context.get("summary", "") if context else ""

    # Extract epic + stories
    llm = get_llm()
    prompt = MULTI_TICKET_EXTRACTION_PROMPT.format(
        message=user_message,
        context=context_str or "No additional context",
    )

    response = await llm.chat(prompt)

    # Parse response
    try:
        data = json.loads(response)
    except json.JSONDecodeError:
        # Try to extract JSON from response
        import re
        match = re.search(r'\{.*\}', response, re.DOTALL)
        if match:
            data = json.loads(match.group())
        else:
            logger.error(f"Failed to parse multi-ticket response: {response}")
            return {"decision_result": {"action": "error", "message": "Failed to extract tickets"}}

    # Build MultiTicketState
    items: list[MultiTicketItem] = []
    epic_id = None
    total_chars = 0

    # Add epic
    if "epic" in data:
        epic_id = str(uuid.uuid4())[:8]
        epic_item: MultiTicketItem = {
            "id": epic_id,
            "type": "epic",
            "title": data["epic"]["title"],
            "description": data["epic"]["description"],
            "parent_id": None,
        }
        items.append(epic_item)
        total_chars += len(epic_item["title"]) + len(epic_item["description"])

    # Add stories
    for story in data.get("stories", []):
        story_item: MultiTicketItem = {
            "id": str(uuid.uuid4())[:8],
            "type": "story",
            "title": story["title"],
            "description": story["description"],
            "parent_id": epic_id,
        }
        items.append(story_item)
        total_chars += len(story_item["title"]) + len(story_item["description"])

    multi_state: MultiTicketState = {
        "items": items,
        "epic_id": epic_id,
        "total_chars": total_chars,
        "confirmed_quantity": False,
        "confirmed_size": False,
        "created_keys": [],
    }

    # Check safety latches
    if len(items) > MULTI_TICKET_QUANTITY_THRESHOLD and not multi_state["confirmed_quantity"]:
        logger.info(f"Quantity latch triggered: {len(items)} items > {MULTI_TICKET_QUANTITY_THRESHOLD}")
        return {
            "multi_ticket_state": multi_state,
            "pending_action": PendingAction.WAITING_QUANTITY_CONFIRM,
            "workflow_step": WorkflowStep.MULTI_TICKET_PREVIEW,
            "decision_result": {
                "action": "quantity_confirm",
                "item_count": len(items),
            },
        }

    if total_chars > MULTI_TICKET_SIZE_THRESHOLD and not multi_state["confirmed_size"]:
        logger.info(f"Size latch triggered: {total_chars} chars > {MULTI_TICKET_SIZE_THRESHOLD}")
        return {
            "multi_ticket_state": multi_state,
            "pending_action": PendingAction.WAITING_SIZE_CONFIRM,
            "workflow_step": WorkflowStep.MULTI_TICKET_PREVIEW,
            "decision_result": {
                "action": "size_confirm",
                "total_chars": total_chars,
            },
        }

    # No latches triggered - show preview
    return {
        "multi_ticket_state": multi_state,
        "workflow_step": WorkflowStep.MULTI_TICKET_PREVIEW,
        "pending_action": PendingAction.WAITING_APPROVAL,
        "decision_result": {
            "action": "multi_ticket_preview",
            "items": items,
        },
    }
```
  </action>
  <verify>python -c "from src.graph.nodes.multi_ticket import extract_multi_ticket; print('OK')"</verify>
  <done>Multi-ticket extraction node with safety latches</done>
</task>

<task type="auto">
  <name>Task 3: Create multi-ticket preview blocks</name>
  <files>src/slack/blocks/multi_ticket.py</files>
  <action>
Create new file `src/slack/blocks/multi_ticket.py`:

```python
"""Slack blocks for multi-ticket preview and confirmation."""


def build_quantity_confirm_blocks(item_count: int) -> list[dict]:
    """Build confirmation dialog for >3 items."""
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"You're about to create *{item_count} items*. This includes 1 Epic and {item_count - 1} linked stories.\n\nWould you like to proceed?",
            },
        },
        {
            "type": "actions",
            "elements": [
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": f"Yes, create {item_count} items"},
                    "action_id": "multi_ticket_confirm_quantity",
                    "style": "primary",
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Cancel"},
                    "action_id": "multi_ticket_cancel",
                },
            ],
        },
    ]


def build_size_confirm_blocks(total_chars: int) -> list[dict]:
    """Build confirmation for large batch."""
    kb = total_chars // 1024
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"This is a large batch (~{kb}KB of content).\n\nWould you like to:\nâ€¢ *Create all at once* - Everything in one batch\nâ€¢ *Split into batches* - Create Epic first, then stories in groups",
            },
        },
        {
            "type": "actions",
            "elements": [
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Create all at once"},
                    "action_id": "multi_ticket_create_all",
                    "style": "primary",
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Split into batches"},
                    "action_id": "multi_ticket_split",
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Cancel"},
                    "action_id": "multi_ticket_cancel",
                },
            ],
        },
    ]


def build_multi_ticket_preview_blocks(items: list[dict], ui_version: int = 0) -> list[dict]:
    """Build preview blocks for all items."""
    blocks = [
        {
            "type": "header",
            "text": {
                "type": "plain_text",
                "text": f"Multi-Ticket Preview ({len(items)} items)",
            },
        },
    ]

    for item in items:
        emoji = "ðŸ“˜" if item["type"] == "epic" else "ðŸ“„"
        blocks.append({
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"{emoji} *{item['type'].title()}*: {item['title']}\n_{item['description'][:100]}{'...' if len(item['description']) > 100 else ''}_",
            },
            "accessory": {
                "type": "button",
                "text": {"type": "plain_text", "text": "Edit"},
                "action_id": f"multi_ticket_edit_story:{item['id']}:{ui_version}",
            },
        })

    blocks.append({"type": "divider"})
    blocks.append({
        "type": "actions",
        "elements": [
            {
                "type": "button",
                "text": {"type": "plain_text", "text": "Create All in Jira"},
                "action_id": f"multi_ticket_approve:{ui_version}",
                "style": "primary",
            },
            {
                "type": "button",
                "text": {"type": "plain_text", "text": "Cancel"},
                "action_id": "multi_ticket_cancel",
            },
        ],
    })

    return blocks
```
  </action>
  <verify>python -c "from src.slack.blocks.multi_ticket import build_multi_ticket_preview_blocks; print('OK')"</verify>
  <done>Multi-ticket blocks for quantity confirm, size confirm, and preview</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] MultiTicketState and MultiTicketItem TypedDicts exist
- [ ] extract_multi_ticket applies quantity latch (>3 items)
- [ ] extract_multi_ticket applies size latch (>10k chars)
- [ ] Preview blocks show all items with Edit buttons
- [ ] `python -m pytest tests/ -x --tb=short` passes
</verification>

<success_criteria>
- Multi-ticket state tracks epic + stories
- Quantity latch triggers for >3 items
- Size latch triggers for >10k chars
- Preview shows all items with edit capability
- Stories linked to Epic (not subtasks)
</success_criteria>

<output>
After completion, create `.planning/phases/20-brain-refactor/20-09-SUMMARY.md`
</output>
