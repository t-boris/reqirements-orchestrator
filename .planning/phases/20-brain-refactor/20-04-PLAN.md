---
phase: 20-brain-refactor
plan: 04
type: execute
wave: 2
depends_on: ["20-01", "20-02", "20-03"]
files_modified:
  - src/schemas/state.py
  - src/graph/graph.py
autonomous: true
---

<objective>
Extend AgentState with new workflow fields: pending_action, pending_payload, workflow_step, ui_version.

Purpose: Enable resumable workflow and event validation. State knows where to continue and can validate events.
Output: AgentState extended with new fields, working with existing graph.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-brain-refactor/20-CONTEXT.md
@.planning/phases/20-brain-refactor/20-01-SUMMARY.md
@src/schemas/state.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add workflow state fields to AgentState</name>
  <files>src/schemas/state.py</files>
  <action>
Add new fields to AgentState TypedDict after the existing intent_result field:

```python
    # Workflow state (Phase 20 - Brain Refactor)
    # Replaces overloaded intent with explicit workflow state
    pending_action: Optional[PendingAction]  # What workflow is waiting for
    pending_payload: Optional[dict[str, Any]]  # Minimal refs for pending action (story_id, draft_id)
    workflow_step: Optional[WorkflowStep]  # Current workflow position (typed, not str)
    ui_version: int  # Incremented on each preview update (for stale button detection)

    # Event tracking for idempotency
    last_event_id: Optional[str]  # Last processed event ID
    last_event_type: Optional[WorkflowEventType]  # Type of last event
```

Key design from 20-CONTEXT.md:
- pending_payload must be minimal identifiers only (story_id, draft_id)
- Large data stays in multi_ticket_state / draft_store
- ui_version prevents stale preview button clicks
  </action>
  <verify>python -c "from src.schemas.state import AgentState; print('pending_action' in AgentState.__annotations__)"</verify>
  <done>AgentState has pending_action, pending_payload, workflow_step, ui_version fields</done>
</task>

<task type="auto">
  <name>Task 2: Add thread_default_intent field</name>
  <files>src/schemas/state.py</files>
  <action>
Add thread-level preferences field to AgentState:

```python
    # Thread-level preferences (Phase 20)
    thread_default_intent: Optional[UserIntent]  # "Remember for this thread" choice
    thread_default_expires_at: Optional[str]  # ISO timestamp, expires after 2h inactivity
```

This implements the "Remember for this thread" feature from the scope gate.
Reset conditions (from 20-CONTEXT.md v4):
- Expires after 2h inactivity
- OR when workflow_step leaves {REVIEW_ACTIVE, REVIEW_FROZEN}
- OR explicit `/maro forget` command
  </action>
  <verify>python -c "from src.schemas.state import AgentState; print('thread_default_intent' in AgentState.__annotations__)"</verify>
  <done>AgentState has thread_default_intent and thread_default_expires_at fields</done>
</task>

<task type="auto">
  <name>Task 3: Initialize new fields in graph runner</name>
  <files>src/graph/runner.py</files>
  <action>
Find where initial state is created (likely in _create_initial_state or similar) and add defaults for new fields:

```python
# Add to initial state dict:
"pending_action": None,
"pending_payload": None,
"workflow_step": None,
"ui_version": 0,
"last_event_id": None,
"last_event_type": None,
"thread_default_intent": None,
"thread_default_expires_at": None,
```

This ensures existing code continues to work with default values.
  </action>
  <verify>python -c "from src.graph.runner import get_runner; print('OK')"</verify>
  <done>New fields have default values in initial state</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.schemas.state import AgentState, PendingAction, WorkflowStep"` succeeds
- [ ] AgentState includes all new fields
- [ ] `python -m pytest tests/ -x --tb=short` passes (no regressions)
- [ ] Graph can be compiled and run with new state fields
</verification>

<success_criteria>
- AgentState extended with pending_action, pending_payload, workflow_step, ui_version
- AgentState extended with thread_default_intent, thread_default_expires_at
- All new fields have sensible defaults
- Existing code continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/20-brain-refactor/20-04-SUMMARY.md`
</output>
