---
phase: 04-slack-router
plan: 08
type: execute
wave: 4
depends_on: ["04-04", "04-05"]
files_modified: [src/slack/dedup_suggest.py, src/slack/handlers.py]
autonomous: true
---

<objective>
Create deduplication suggestions (non-blocking, high-confidence only).

Purpose: Implement Rule 2 (Traffic Cop) - suggest similar threads without blocking.
Output: Dedup detector that suggests related threads with "Merge context" action.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-slack-router/04-CONTEXT.md
@.planning/phases/04-slack-router/04-04-SUMMARY.md
@.planning/phases/04-slack-router/04-05-SUMMARY.md

DoD from CONTEXT for Rule 2: Dedup:
- Non-blocking suggestion only
- Logs similarity score + rationale
- Button: "Merge context" (adds link to other thread into session card / epic summary)

Key principle: Only trigger on extremely high similarity. Suggest, don't block.

@src/memory/zep_client.py
@src/slack/blocks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dedup suggestion logic</name>
  <files>src/slack/dedup_suggest.py</files>
  <action>
Create src/slack/dedup_suggest.py:

```python
"""Deduplication suggestions for similar threads.

Rule 2: Traffic Cop - Non-blocking suggestions only.
"""

import logging
from typing import Optional
from slack_sdk.web import WebClient

from src.memory.zep_client import search_similar_threads
from src.slack.session import SessionIdentity

logger = logging.getLogger(__name__)

# High threshold to avoid false positives
SIMILARITY_THRESHOLD = 0.85

async def check_for_duplicates(
    message_text: str,
    identity: SessionIdentity,
    epic_key: Optional[str] = None,
) -> Optional[dict]:
    """Check if similar thread exists.

    Returns similar thread info if found with high confidence.
    Returns None if no similar thread or below threshold.

    Args:
        message_text: Message content to check
        identity: Current session identity
        epic_key: Optionally filter to same Epic

    Returns:
        {session_id, summary, score, thread_link} or None
    """
    try:
        similar = await search_similar_threads(
            query=message_text,
            epic_key=epic_key,
            limit=1,
        )

        if not similar:
            return None

        top_match = similar[0]
        score = top_match.get("score", 0)

        # Only suggest if extremely high confidence
        if score < SIMILARITY_THRESHOLD:
            logger.debug(
                f"Similar thread below threshold",
                extra={
                    "score": score,
                    "threshold": SIMILARITY_THRESHOLD,
                }
            )
            return None

        # Parse session_id to get thread link
        # Format: team:channel:thread_ts
        parts = top_match["session_id"].split(":")
        if len(parts) >= 3:
            channel_id = parts[1]
            thread_ts = parts[2]
            thread_link = f"slack://channel?team={parts[0]}&id={channel_id}&message={thread_ts}"
        else:
            thread_link = None

        logger.info(
            f"Similar thread found",
            extra={
                "current_session": identity.session_id,
                "similar_session": top_match["session_id"],
                "score": score,
                "rationale": "Semantic similarity above threshold",
            }
        )

        return {
            "session_id": top_match["session_id"],
            "summary": top_match.get("summary", ""),
            "score": score,
            "thread_link": thread_link,
        }

    except Exception as e:
        logger.warning(f"Dedup check failed: {e}")
        return None

def build_dedup_suggestion_blocks(
    similar_thread: dict,
    current_summary: str,
) -> list[dict]:
    """Build blocks for dedup suggestion message.

    Non-blocking: Just a suggestion with optional action.
    """
    blocks = []

    # Info section
    blocks.append({
        "type": "section",
        "text": {
            "type": "mrkdwn",
            "text": f":information_source: *Similar discussion found*\n\n"
                    f"_{similar_thread['summary'][:200]}..._\n\n"
                    f"Similarity: {similar_thread['score']:.0%}"
        }
    })

    # Action buttons
    actions = []

    if similar_thread.get("thread_link"):
        actions.append({
            "type": "button",
            "text": {
                "type": "plain_text",
                "text": "View related thread",
                "emoji": True
            },
            "url": similar_thread["thread_link"],
            "action_id": "view_similar_thread",
        })

    actions.append({
        "type": "button",
        "text": {
            "type": "plain_text",
            "text": "Merge context",
            "emoji": True
        },
        "value": similar_thread["session_id"],
        "action_id": "merge_thread_context",
    })

    actions.append({
        "type": "button",
        "text": {
            "type": "plain_text",
            "text": "Ignore",
            "emoji": True
        },
        "action_id": "ignore_dedup_suggestion",
    })

    blocks.append({
        "type": "actions",
        "elements": actions
    })

    # Context note
    blocks.append({
        "type": "context",
        "elements": [{
            "type": "mrkdwn",
            "text": "This is just a suggestion - continue your discussion normally."
        }]
    })

    return blocks

async def maybe_suggest_dedup(
    client: WebClient,
    identity: SessionIdentity,
    message_text: str,
    epic_key: Optional[str] = None,
) -> bool:
    """Check for duplicates and post suggestion if found.

    Returns True if suggestion was posted, False otherwise.
    """
    similar = await check_for_duplicates(
        message_text=message_text,
        identity=identity,
        epic_key=epic_key,
    )

    if not similar:
        return False

    blocks = build_dedup_suggestion_blocks(
        similar_thread=similar,
        current_summary=message_text[:200],
    )

    client.chat_postMessage(
        channel=identity.channel_id,
        thread_ts=identity.thread_ts,
        text="Similar discussion found",
        blocks=blocks,
    )

    return True
```
  </action>
  <verify>python -c "from src.slack.dedup_suggest import maybe_suggest_dedup, check_for_duplicates; print('dedup suggest ok')"</verify>
  <done>Dedup suggestion with high-confidence threshold</done>
</task>

<task type="auto">
  <name>Task 2: Add merge context action handler</name>
  <files>src/slack/handlers.py</files>
  <action>
Add merge context action handler to src/slack/handlers.py:

```python
async def handle_merge_context(ack, body, client, action):
    """Handle 'Merge context' button click.

    Links the related thread in session card and Epic summary.
    """
    ack()

    similar_session_id = action.get("value")
    channel = body["channel"]["id"]
    thread_ts = body["message"].get("thread_ts") or body["message"]["ts"]

    logger.info(
        f"Merge context requested",
        extra={
            "current_thread": thread_ts,
            "similar_session": similar_session_id,
        }
    )

    # Acknowledge the merge
    client.chat_postMessage(
        channel=channel,
        thread_ts=thread_ts,
        text=f"Context linked from related thread. I'll consider both discussions when gathering requirements.",
    )

    # TODO: Update session card with linked thread reference
    # TODO: Update Epic summary with cross-reference

async def handle_ignore_dedup(ack, body, client):
    """Handle 'Ignore' button click on dedup suggestion."""
    ack()

    # Just acknowledge - user chose to continue independently
    channel = body["channel"]["id"]
    thread_ts = body["message"].get("thread_ts") or body["message"]["ts"]

    # Delete the suggestion message
    message_ts = body["message"]["ts"]
    try:
        client.chat_delete(channel=channel, ts=message_ts)
    except Exception:
        pass  # May not have permission to delete
```

Also update router.py to register these action handlers:
- action_id: "merge_thread_context"
- action_id: "ignore_dedup_suggestion"
  </action>
  <verify>python -c "from src.slack.handlers import handle_merge_context, handle_ignore_dedup; print('action handlers ok')"</verify>
  <done>Merge context and ignore action handlers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.slack.dedup_suggest import maybe_suggest_dedup"` succeeds
- [ ] High similarity threshold (0.85) set
- [ ] Suggestion is non-blocking (context note included)
- [ ] Action handlers for merge/ignore
- [ ] Logging includes score and rationale
</verification>

<success_criteria>

- All tasks completed
- Dedup only triggers on extremely high similarity
- Non-blocking suggestion with action buttons
- Merge context handler acknowledges the link
- DoD: Logs similarity score + rationale
</success_criteria>

<output>
After completion, create `.planning/phases/04-slack-router/04-08-SUMMARY.md`
</output>
