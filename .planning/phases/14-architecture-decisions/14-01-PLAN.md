---
phase: 14-architecture-decisions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graph/intent.py
  - src/graph/nodes/review.py
  - src/slack/handlers.py
  - src/slack/blocks.py
  - src/schemas/state.py
autonomous: true
---

<objective>
Auto-detect architecture decisions after review and post to channel.

Purpose: When user approves a review ("let's go with this"), MARO extracts the decision summary and posts it to the channel as a permanent record. Thread = thinking process, Channel = approved decisions.

Output:
- DECISION_APPROVAL intent detection (patterns like "let's go with this")
- Review context saved after review_node completes
- LLM extracts decision summary
- Formatted decision posted to channel (not thread)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-architecture-decisions/14-CONTEXT.md
@src/graph/intent.py
@src/graph/nodes/review.py
@src/slack/handlers.py
@src/schemas/state.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Decision approval detection and review context storage</name>
  <files>src/graph/intent.py, src/schemas/state.py, src/graph/nodes/review.py</files>
  <action>
1. Add DECISION_APPROVAL patterns to intent.py (check AFTER REVIEW patterns):
   ```python
   # Decision approval patterns - user approving a review/architecture discussion
   DECISION_APPROVAL_PATTERNS = [
       (r"\blet'?s?\s+go\s+with\s+(?:this|that|option|approach)\b", "pattern: let's go with this"),
       (r"\bapproved\b", "pattern: approved"),
       (r"\bagreed\b", "pattern: agreed"),
       (r"\bship\s+it\b", "pattern: ship it"),
       (r"\blooks?\s+good,?\s+let'?s?\s+(?:do|proceed)\b", "pattern: looks good let's proceed"),
       (r"\bthis\s+is\s+(?:the|our)\s+approach\b", "pattern: this is the approach"),
       (r"\bI\s+(?:like|prefer)\s+(?:this|option)\b", "pattern: I like/prefer this"),
       (r"\bgo\s+(?:ahead|for\s+it)\b", "pattern: go ahead"),
       (r"\bsounds?\s+good\b", "pattern: sounds good"),
   ]
   ```

2. Add new IntentType:
   - DECISION_APPROVAL = "DECISION_APPROVAL"  # User approving review/architecture discussion

3. Update classify_intent_patterns() to check DECISION_APPROVAL:
   - Check after REVIEW patterns (these only trigger in review context)
   - Return IntentResult with intent=DECISION_APPROVAL

4. Add review_context field to AgentState in state.py:
   ```python
   # Architecture decision tracking (Phase 14)
   review_context: Optional[dict[str, Any]]  # Saved review for decision extraction
   # Structure: {
   #     "topic": str,                    # From intent_result.topic
   #     "review_summary": str,           # The review analysis text
   #     "persona": str,                  # Which persona gave the review
   #     "review_timestamp": str,         # ISO timestamp
   #     "thread_ts": str,                # Thread where review happened
   #     "channel_id": str,               # Channel for posting decision
   # }
   ```

5. Update review_node to save review_context after generating analysis:
   - After successful LLM call, populate review_context in returned state update
   - Include: topic, review_summary (the analysis), persona, thread_ts, channel_id, timestamp
  </action>
  <verify>python -c "from src.graph.intent import IntentType; print(IntentType.DECISION_APPROVAL)"</verify>
  <done>DECISION_APPROVAL patterns exist, review_context saved after review</done>
</task>

<task type="auto">
  <name>Task 2: Decision extraction and channel posting</name>
  <files>src/slack/handlers.py, src/slack/blocks.py</files>
  <action>
1. Add build_decision_blocks() function to blocks.py:
   ```python
   def build_decision_blocks(
       topic: str,
       decision: str,
       channel_id: str,
       thread_ts: str,
       user_id: str,
   ) -> list[dict]:
       """Build Slack blocks for architecture decision post.

       Format:
       üìê *Architecture Decision*

       *Topic:* {topic}
       *Decision:* {decision}

       _View discussion ‚Ä¢ Decided by @user_
       """
       return [
           {
               "type": "section",
               "text": {
                   "type": "mrkdwn",
                   "text": f"üìê *Architecture Decision*\n\n*Topic:* {topic}\n*Decision:* {decision}"
               }
           },
           {
               "type": "context",
               "elements": [
                   {
                       "type": "mrkdwn",
                       "text": f"<https://slack.com/archives/{channel_id}/p{thread_ts.replace('.', '')}|View discussion> ‚Ä¢ Decided by <@{user_id}>"
                   }
               ]
           }
       ]
   ```

2. Add decision extraction prompt and handler in handlers.py:
   - Create DECISION_EXTRACTION_PROMPT constant
   - When DECISION_APPROVAL intent detected AND review_context exists:
     a. Call LLM to extract decision summary from review_context.review_summary
     b. Build decision blocks with topic and extracted decision
     c. Post to CHANNEL (not thread!) using client.chat_postMessage(channel=channel_id, blocks=blocks)
     d. Reply in thread: "Decision recorded in channel."
     e. Clear review_context from state

3. Decision extraction prompt:
   ```python
   DECISION_EXTRACTION_PROMPT = '''Based on this architecture review, extract the decision:

   Review: {review_summary}
   User's approval: {approval_message}

   Return a JSON object:
   {{
       "topic": "What was being decided (1 line)",
       "decision": "The chosen approach (1-2 sentences)"
   }}

   Be concise. This will be posted to the channel as a permanent record.
   '''
   ```

4. Handle the decision_approval action in the action dispatch section:
   - Get review_context from state
   - If no review_context: reply "No recent review to approve."
   - If review_context exists: extract decision, post to channel, confirm in thread

5. Add logging for decision detection:
   ```python
   logger.info(
       "Architecture decision detected",
       extra={
           "channel_id": channel_id,
           "thread_ts": thread_ts,
           "topic": topic,
           "user_id": user_id,
       }
   )
   ```
  </action>
  <verify>Grep for "build_decision_blocks" and "DECISION_EXTRACTION_PROMPT" in the codebase</verify>
  <done>Decision extraction works, formatted decision posted to channel, thread gets confirmation</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.graph.intent import IntentType; print(IntentType.DECISION_APPROVAL)"` works
- [ ] `grep -r "review_context" src/` shows field in state.py and review.py
- [ ] `grep -r "build_decision_blocks" src/` shows function in blocks.py
- [ ] No Python syntax errors or import issues
</verification>

<success_criteria>
- DECISION_APPROVAL intent type with approval patterns
- review_context field in AgentState populated after review
- LLM extracts decision summary from review context
- Formatted decision posted to channel (üìê Architecture Decision)
- Thread gets confirmation message
- Logging shows decision detection
</success_criteria>

<output>
After completion, create `.planning/phases/14-architecture-decisions/14-01-SUMMARY.md`
</output>
