---
phase: 06-skills
plan: 02
status: ready
estimated_tasks: 5
---

# Plan 06-02: preview_ticket Skill with Version Checking

## Objective

Build the `preview_ticket` skill that shows draft previews with approval buttons, implements strict version checking to ensure users approve exactly what they see, and stores approval records for idempotency.

## Execution Context

- Base: src/slack/blocks.py (existing build_draft_preview_blocks)
- Base: src/slack/handlers.py (existing handle_approve_draft, handle_reject_draft)
- Base: src/schemas/draft.py (TicketDraft with version field)
- Reference: Phase 5 decisions (05-04: approval buttons exist)

## Context

From 06-CONTEXT.md:
- Input: `channel`, `thread_ts`, `draft`, `preview_id`
- Output: `preview_message_ts`, `preview_id`, `status="posted"`
- Evidence links: show 2-3 key source messages inline in preview blocks
- Button actions: `approve_draft`, `reject_draft` (opens modal)
- Draft hash embedded in button value for version checking
- Idempotency pattern:
  - Dedup key: `(session_id, state_version)`
  - Button clicks: first wins + ignore subsequent + update message to show approved state
- Approval records: PostgreSQL table with unique constraint on `(session_id, draft_hash)`

Current state:
- `build_draft_preview_blocks()` exists but doesn't embed version hash
- `handle_approve_draft()` exists but doesn't check version
- No approval record storage

## Tasks

### Task 1: Create preview_ticket skill module

Create `src/skills/preview_ticket.py` with:
- `PreviewResult` Pydantic model: `message_ts`, `preview_id`, `draft_hash`, `status`
- `preview_ticket()` async function that:
  - Computes draft hash (deterministic from draft content)
  - Posts preview with embedded hash in button values
  - Returns PreviewResult

Draft hash: SHA256 of `f"{draft.title}|{draft.problem}|{','.join(draft.acceptance_criteria)}"`[:8]

Files:
- Create: src/skills/preview_ticket.py
- Edit: src/skills/__init__.py (export preview_ticket)

Checkpoint: `python -c "from src.skills.preview_ticket import preview_ticket; print('ok')"`

### Task 2: Update preview blocks with version hash and evidence

Enhance `build_draft_preview_blocks()`:
- Embed `draft_hash` in button values: `action_value = f"{session_id}:{draft_hash}"`
- Add evidence links inline (2-3 key sources with permalinks)
- Show "Based on X messages" in context block

Evidence format:
```
*Sources:*
• <permalink1|Message from @user1>: "first 50 chars..."
• <permalink2|Message from @user2>: "first 50 chars..."
```

Files:
- Edit: src/slack/blocks.py (enhance build_draft_preview_blocks)

Checkpoint: Manual review of blocks output

### Task 3: Create approval records table

Create PostgreSQL table for approval records:
```sql
CREATE TABLE IF NOT EXISTS approval_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id TEXT NOT NULL,
    draft_hash TEXT NOT NULL,
    approved_by TEXT NOT NULL,
    approved_at TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'approved',
    UNIQUE(session_id, draft_hash)
);
```

Create `src/db/approval_store.py`:
- `ApprovalRecord` Pydantic model
- `ApprovalStore` class with:
  - `record_approval()` - insert, return True if new, False if duplicate
  - `get_approval()` - check if approval exists
  - `get_approver()` - get who approved (for feedback messages)

Files:
- Create: src/db/approval_store.py
- Edit: src/db/__init__.py (export ApprovalStore)

Checkpoint: `python -c "from src.db.approval_store import ApprovalStore; print('ok')"`

### Task 4: Implement version-checked approval handler

Update `handle_approve_draft()`:
1. Parse `session_id:draft_hash` from button value
2. Check if approval record exists:
   - If exists: respond "Already approved by @user", return
3. Get current draft from runner state
4. Compute current draft hash
5. Compare with button hash:
   - If match: record approval, proceed
   - If mismatch: post "Draft changed since preview, please review again", show new preview
6. Update original preview message:
   - Disable buttons (remove actions block)
   - Add "Approved by @user at TIME" to context

Files:
- Edit: src/slack/handlers.py (handle_approve_draft)

Checkpoint: Code review - approval flow handles all cases

### Task 5: Implement idempotent button handling

Ensure button clicks are idempotent:
- First click: process approval/rejection
- Subsequent clicks: "Already processed" message
- Update message immediately to show state

Add to handlers.py:
- In-memory dedup for recent button clicks (5-minute TTL)
- Update preview message to disable buttons after first click

Handle race conditions:
- PostgreSQL unique constraint catches DB-level races
- In-memory dedup catches Slack retry races

Files:
- Edit: src/slack/handlers.py (idempotent button handling)
- Edit: src/slack/dedup.py (button click dedup - reuse existing pattern)

Checkpoint: `python -c "from src.slack.handlers import handle_approve_draft; print('ok')"`

## Verification

```bash
# All imports work
python -c "
from src.skills.preview_ticket import preview_ticket, PreviewResult
from src.db.approval_store import ApprovalStore, ApprovalRecord
print('all imports ok')
"

# Draft hash is deterministic
python -c "
from src.skills.preview_ticket import compute_draft_hash
from src.schemas.draft import TicketDraft
draft = TicketDraft(title='Test', problem='Problem', acceptance_criteria=['AC1'])
h1 = compute_draft_hash(draft)
h2 = compute_draft_hash(draft)
assert h1 == h2, 'Hash must be deterministic'
print('hash ok')
"
```

## Success Criteria

- `preview_ticket()` skill posts draft preview with embedded version hash
- Evidence links shown inline with permalinks
- Version checking: stale approvals blocked with re-preview prompt
- Approval records stored in PostgreSQL with unique constraint
- Duplicate button clicks handled gracefully (first wins)
- Preview message updated after approval to show final state

## Output

Files created/modified:
- src/skills/preview_ticket.py (new)
- src/skills/__init__.py (updated)
- src/slack/blocks.py (updated)
- src/db/approval_store.py (new)
- src/db/__init__.py (updated)
- src/slack/handlers.py (updated)
- src/slack/dedup.py (updated if needed)
