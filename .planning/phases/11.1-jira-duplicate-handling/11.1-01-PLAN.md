# Phase 11.1: Jira Duplicate Handling â€” Plan 01: MVP Duplicate Actions

## Objective

Replace current "potential duplicates found" display with actionable duplicate handling that lets users Link to existing tickets, Create new anyway, Add extra info to existing, or Show more matches.

## Execution Context

**Files to modify:**
- `src/slack/blocks.py` â€” Enhanced duplicate display with action buttons
- `src/slack/handlers.py` â€” New button action handlers
- `src/graph/nodes/decision.py` â€” Add LLM match explanation
- `src/skills/jira_search.py` â€” Return richer metadata for duplicates
- `src/jira/client.py` â€” Fetch additional issue fields (status, assignee, updated)

**Reference files:**
- `src/skills/preview_ticket.py` â€” Current preview flow
- `src/skills/dispatcher.py` â€” Decision routing
- `src/schemas/draft.py` â€” TicketDraft structure

**Context from discussion (11.1-CONTEXT.md):**
- Smart matching with WHY explanation (same feature area, same action, same entities)
- Actions: Link / Create / Add extra info / Show more
- Best match first, modal for more matches
- Simple "Linked to PROJ-1234" confirmation after linking

## Context

### Current State
- Duplicates found via text search in decision node
- Displayed as static links in preview (max 3 shown)
- No action buttons on duplicates â€” users must manually decide
- No explanation of WHY matches were found

### Target State
- Rich duplicate message explaining match reasoning
- Four actions per duplicate: Link / Create new / Add info / Show more
- Modal for viewing all matches when >1 found
- Confirmation after linking: "Linked to PROJ-1234"

### Scope Limitation (MVP)
This plan covers the core UX. Deferred to future phases:
- Bidirectional sync (Phase 11.4)
- Channel Jira Board (Phase 11.3)
- Comment vs Description contributions (Phase 11.3)

## Tasks

### Task 1: Enhance Duplicate Metadata

**File:** `src/jira/client.py`

Update `search_issues()` to return richer metadata:
- status (name)
- assignee (display name)
- updated (date)

**Changes:**
1. In `search_issues()` method, ensure fields list includes: `key`, `summary`, `status`, `assignee`, `updated`
2. Parse and return these in `JiraIssue` objects

**File:** `src/jira/types.py`

Ensure `JiraIssue` has:
```python
@dataclass
class JiraIssue:
    key: str
    summary: str
    url: str
    status: str = ""
    assignee: str = ""
    updated: str = ""
```

**Verification:** Run `pytest tests/test_jira_client.py -v` (if exists) or manual test

---

### Task 2: Add LLM Match Explanation

**File:** `src/graph/nodes/decision.py`

Add function to generate match explanation using LLM:

```python
async def _explain_duplicate_match(
    draft: TicketDraft,
    duplicate: dict,
) -> str:
    """Generate concise explanation of why duplicate matches draft.

    Returns explanation like:
    "same feature area (notifications), same main action (scheduling)"
    """
```

**Logic:**
1. Create simple prompt comparing draft title/problem with duplicate summary
2. Ask LLM to identify matching aspects: feature area, action, entities
3. Return 1-line explanation (max 100 chars)
4. Fail gracefully â€” return empty string on error

**Integration:**
Update `_search_for_duplicates()` to:
1. For best match (first result), call `_explain_duplicate_match()`
2. Add `match_reason` field to duplicate dict

**Verification:** Manual test â€” check logs for match explanation

---

### Task 3: Enhanced Duplicate Display in Preview

**File:** `src/slack/blocks.py`

Replace current duplicate display (lines 287-315) with rich format:

```python
def build_duplicate_blocks(
    potential_duplicates: list[dict],
    session_id: str,
    draft_hash: str,
) -> list[dict]:
    """Build blocks for duplicate detection with actions."""
```

**Block structure for best match:**
```
ðŸ” Possible existing ticket found

I found a Jira ticket that looks very similar:
â€¢ PROJ-1234 â€” "Scheduled notifications with edit/cancel support"
  Status: In Progress | Assignee: Alex | Updated: 3 days ago

This matches because: same feature area (notifications), same main action (scheduling)

[âœ… Link to this] [âž• Add as info] [ðŸ“ Create new] [ðŸ” Show more]
```

**Button value encoding:**
- `link_duplicate:{session_id}:{draft_hash}:{issue_key}`
- `add_to_duplicate:{session_id}:{draft_hash}:{issue_key}`
- `create_anyway:{session_id}:{draft_hash}`
- `show_more_duplicates:{session_id}:{draft_hash}`

**Verification:** Post preview with duplicates, verify buttons render correctly

---

### Task 4: Link to Duplicate Handler

**File:** `src/slack/handlers.py`

Add handler for `link_duplicate` button:

```python
async def _handle_link_duplicate(
    ack: AsyncAck,
    body: dict,
    client: AsyncWebClient,
    logger: logging.Logger,
):
    """Handle user choosing to link thread to existing ticket."""
```

**Flow:**
1. Parse button value: session_id, draft_hash, issue_key
2. Store thread binding: `{thread_ts, channel_id} â†’ issue_key`
3. Update preview message to confirmation state
4. Post confirmation: "âœ… Linked to PROJ-1234. I'll keep you posted on updates."

**Storage (new):** `src/slack/thread_bindings.py`
```python
class ThreadBindingStore:
    """Store thread â†’ Jira ticket bindings."""

    async def bind(self, channel_id: str, thread_ts: str, issue_key: str) -> None
    async def get_binding(self, channel_id: str, thread_ts: str) -> str | None
    async def unbind(self, channel_id: str, thread_ts: str) -> bool
```

Use in-memory dict for MVP, can migrate to DB later.

**Verification:** Click "Link to this" â†’ verify confirmation message appears

---

### Task 5: Create Anyway Handler

**File:** `src/slack/handlers.py`

Add handler for `create_anyway` button:

```python
async def _handle_create_anyway(
    ack: AsyncAck,
    body: dict,
    client: AsyncWebClient,
    logger: logging.Logger,
):
    """Handle user choosing to create new ticket despite duplicates."""
```

**Flow:**
1. Parse button value: session_id, draft_hash
2. Delegate to existing `_handle_approve_draft_async()` flow
3. Proceed with ticket creation

**Verification:** Click "Create new" â†’ verify ticket is created normally

---

### Task 6: Add to Duplicate Handler (Stub)

**File:** `src/slack/handlers.py`

Add handler for `add_to_duplicate` button:

```python
async def _handle_add_to_duplicate(
    ack: AsyncAck,
    body: dict,
    client: AsyncWebClient,
    logger: logging.Logger,
):
    """Handle user choosing to add conversation info to existing ticket."""
```

**MVP behavior:**
1. Post message: "Adding info to existing tickets will be available soon. For now, link to PROJ-1234 or create a new ticket."
2. This is a stub â€” full implementation in Phase 11.3

**Verification:** Click "Add as info" â†’ verify stub message appears

---

### Task 7: Show More Duplicates Modal

**File:** `src/slack/handlers.py`

Add handler for `show_more_duplicates` button:

```python
async def _handle_show_more_duplicates(
    ack: AsyncAck,
    body: dict,
    client: AsyncWebClient,
    logger: logging.Logger,
):
    """Open modal showing all duplicate matches with actions."""
```

**Modal structure:**
```
Title: Similar Tickets Found

[For each duplicate (up to 5):]
â€¢ PROJ-1234 â€” "Ticket summary"
  Status: In Progress | Updated: 3 days ago
  [Link to this] [View in Jira â†—]

---
[Create new ticket anyway]
```

**File:** `src/slack/modals/duplicate_modal.py` (new)

```python
def build_duplicate_modal(
    duplicates: list[dict],
    session_id: str,
    draft_hash: str,
) -> dict:
    """Build modal view for duplicate selection."""
```

**Verification:** Click "Show more" â†’ modal opens with all duplicates

---

### Task 8: Register Button Handlers

**File:** `src/slack/handlers.py`

Register all new action handlers:

```python
# In register_handlers():
app.action("link_duplicate")(handle_link_duplicate)
app.action("add_to_duplicate")(handle_add_to_duplicate)
app.action("create_anyway")(handle_create_anyway)
app.action("show_more_duplicates")(handle_show_more_duplicates)
```

**Verification:** All buttons trigger correct handlers

---

### Task 9: Update Preview to Hide Standard Buttons When Duplicates Found

**File:** `src/slack/blocks.py`

When duplicates are found:
- Show duplicate action buttons INSTEAD OF standard "Approve & Create" / "Needs Changes"
- User must first decide: Link or Create
- After clicking "Create new", show standard approval flow

**Logic update in `build_draft_preview_blocks_with_hash()`:**
```python
if potential_duplicates:
    # Show duplicate blocks with actions (no standard buttons)
    blocks.extend(build_duplicate_blocks(...))
else:
    # Show standard approval buttons
    blocks.extend(build_approval_buttons(...))
```

**Verification:** Preview with duplicates shows ONLY duplicate action buttons

---

### Task 10: Confirmation Message After Linking

**File:** `src/slack/blocks.py`

Add function for linked confirmation:

```python
def build_linked_confirmation_blocks(
    issue_key: str,
    issue_url: str,
) -> list[dict]:
    """Build confirmation blocks after linking to existing ticket."""
```

**Output:**
```
âœ… Linked to PROJ-1234

This thread is now connected to the existing ticket. Any updates will be shared here.

[View in Jira â†—] [Unlink]
```

**Verification:** After linking, preview message is replaced with confirmation

## Verification

1. **Happy path - Link to duplicate:**
   - Start new thread with requirements similar to existing ticket
   - Preview shows "Possible existing ticket found" with match explanation
   - Click "Link to this" â†’ confirmation appears
   - Thread is bound to existing ticket

2. **Create anyway path:**
   - Start new thread with requirements similar to existing ticket
   - Preview shows duplicate warning
   - Click "Create new" â†’ standard approval flow resumes
   - Ticket created normally

3. **Show more path:**
   - Start thread matching multiple existing tickets
   - Preview shows best match with "Show more" button
   - Click "Show more" â†’ modal with all matches
   - Can link from modal

4. **No duplicates:**
   - Start thread with unique requirements
   - Preview shows standard "Approve & Create" / "Needs Changes" (no change)

## Success Criteria

- [ ] Duplicate display shows WHY tickets match (match explanation)
- [ ] Four action buttons work: Link / Add info (stub) / Create new / Show more
- [ ] Link action binds thread to ticket with confirmation
- [ ] Create action proceeds with normal ticket creation
- [ ] Show more opens modal with all duplicates
- [ ] Standard flow unchanged when no duplicates found

## Output

After completion:
- Thread binding store for link tracking
- Rich duplicate display with LLM explanation
- Action buttons for all duplicate handling paths
- Modal for viewing multiple matches
- Confirmation flow after linking

Update STATE.md and ROADMAP.md to mark 11.1-01 complete.
