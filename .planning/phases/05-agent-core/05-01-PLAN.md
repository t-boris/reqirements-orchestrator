---
phase: 05-agent-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/schemas/state.py, src/schemas/draft.py, src/schemas/__init__.py]
autonomous: true
---

<objective>
Enhance AgentState and create rich Draft schema for the PM-machine workflow.

Purpose: Foundation for the agent graph - state machine phases, patch-style draft updates, evidence tracking.
Output: Enhanced AgentState with phase enum, TicketDraft with all fields from CONTEXT.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-core/05-CONTEXT.md

Existing schemas:
@src/schemas/state.py
@src/schemas/ticket.py

From CONTEXT.md - Draft Structure:
```
epic_id, title, problem, proposed_solution,
acceptance_criteria[], constraints[] (key/value/status),
open_questions[], dependencies[], risks[],
evidence_links[] (Slack permalinks)
```

State Machine Phases:
`COLLECTING -> VALIDATING -> AWAITING_USER -> READY_TO_CREATE -> CREATED`
- Backwards transitions allowed
- state_version/last_updated_at for race detection

Minimum viable draft for PREVIEW: title + problem + 1 AC
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TicketDraft schema</name>
  <files>src/schemas/draft.py</files>
  <action>
Create src/schemas/draft.py with rich draft structure:

```python
"""Rich draft schema for PM-machine workflow.

Supports patch-style updates with evidence tracking.
"""
from datetime import datetime
from enum import Enum
from typing import Optional
from pydantic import BaseModel, Field
from uuid import uuid4


class ConstraintStatus(str, Enum):
    """Status of a constraint/decision."""
    PROPOSED = "proposed"
    ACCEPTED = "accepted"
    DEPRECATED = "deprecated"


class DraftConstraint(BaseModel):
    """Structured constraint with status tracking."""
    key: str  # e.g., "API.date_format"
    value: str  # e.g., "unix_timestamp"
    status: ConstraintStatus = ConstraintStatus.PROPOSED
    source_message_ts: Optional[str] = None  # Evidence link


class EvidenceLink(BaseModel):
    """Link to source message for traceability."""
    message_ts: str
    thread_ts: str
    channel_id: str
    text_preview: str = ""  # First ~100 chars
    field_updated: str  # Which draft field this evidence supports


class TicketDraft(BaseModel):
    """Rich draft for ticket creation.

    Supports patch-style updates: each field can be updated independently.
    Evidence links trace every extraction back to source messages.

    Minimum viable for PREVIEW: title + problem + 1 AC
    """
    # Identity
    id: str = Field(default_factory=lambda: str(uuid4()))
    epic_id: Optional[str] = None  # Linked Epic key

    # Core fields (required for PREVIEW)
    title: str = ""  # Maps to Jira summary
    problem: str = ""  # What problem we're solving

    # Solution fields
    proposed_solution: str = ""
    acceptance_criteria: list[str] = Field(default_factory=list)

    # Context fields
    constraints: list[DraftConstraint] = Field(default_factory=list)
    open_questions: list[str] = Field(default_factory=list)
    dependencies: list[str] = Field(default_factory=list)
    risks: list[str] = Field(default_factory=list)

    # Traceability
    evidence_links: list[EvidenceLink] = Field(default_factory=list)

    # Metadata
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    version: int = 1  # Increment on each update for race detection

    def is_preview_ready(self) -> bool:
        """Check if draft has minimum viable content for PREVIEW.

        Minimum: title + problem + at least 1 AC
        """
        return bool(
            self.title.strip()
            and self.problem.strip()
            and len(self.acceptance_criteria) >= 1
        )

    def get_missing_for_preview(self) -> list[str]:
        """Get list of fields needed before PREVIEW."""
        missing = []
        if not self.title.strip():
            missing.append("title")
        if not self.problem.strip():
            missing.append("problem")
        if not self.acceptance_criteria:
            missing.append("acceptance_criteria (at least one)")
        return missing

    def add_evidence(
        self,
        message_ts: str,
        thread_ts: str,
        channel_id: str,
        field_updated: str,
        text_preview: str = "",
    ) -> None:
        """Add evidence link for traceability."""
        self.evidence_links.append(EvidenceLink(
            message_ts=message_ts,
            thread_ts=thread_ts,
            channel_id=channel_id,
            text_preview=text_preview[:100] if text_preview else "",
            field_updated=field_updated,
        ))
        self.updated_at = datetime.utcnow()
        self.version += 1

    def patch(self, **updates) -> "TicketDraft":
        """Apply patch-style updates to draft.

        Only updates provided fields, preserves others.
        Increments version and updates timestamp.
        """
        for key, value in updates.items():
            if hasattr(self, key) and value is not None:
                setattr(self, key, value)
        self.updated_at = datetime.utcnow()
        self.version += 1
        return self
```
  </action>
  <verify>python -c "from src.schemas.draft import TicketDraft, DraftConstraint; d = TicketDraft(); print('draft ok', d.is_preview_ready())"</verify>
  <done>TicketDraft with all fields, is_preview_ready(), patch(), evidence tracking</done>
</task>

<task type="auto">
  <name>Task 2: Enhance AgentState with phase enum</name>
  <files>src/schemas/state.py</files>
  <action>
Update src/schemas/state.py to add:

1. AgentPhase enum: COLLECTING, VALIDATING, AWAITING_USER, READY_TO_CREATE, CREATED
2. Replace draft: Optional[JiraTicketBase] with draft: Optional[TicketDraft]
3. Add phase: AgentPhase field (default COLLECTING)
4. Add state_version: int for race detection
5. Add last_updated_at: Optional[str] for timestamp tracking
6. Add step_count: int for loop protection (max_steps=10)
7. Keep messages, thread_ts, channel_id, user_id

Import TicketDraft from src.schemas.draft.

The state should still be TypedDict for LangGraph compatibility, but use Optional[TicketDraft] for the draft field (Pydantic model is JSON-serializable).
  </action>
  <verify>python -c "from src.schemas.state import AgentState, AgentPhase; print('state ok', AgentPhase.COLLECTING)"</verify>
  <done>AgentState has phase enum, draft as TicketDraft, state_version, step_count</done>
</task>

<task type="auto">
  <name>Task 3: Update schemas package exports</name>
  <files>src/schemas/__init__.py</files>
  <action>
Update src/schemas/__init__.py to export:
- TicketDraft, DraftConstraint, ConstraintStatus, EvidenceLink (from draft)
- AgentState, AgentPhase (from state)
- Keep existing ticket exports

Ensure clean imports:
```python
from src.schemas import TicketDraft, AgentState, AgentPhase
```
  </action>
  <verify>python -c "from src.schemas import TicketDraft, AgentState, AgentPhase; print('exports ok')"</verify>
  <done>Clean exports for all schema types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.schemas import TicketDraft, AgentState, AgentPhase"` succeeds
- [ ] TicketDraft.is_preview_ready() returns False for empty draft
- [ ] TicketDraft.patch() increments version
- [ ] AgentPhase has all 5 states
- [ ] No import errors
</verification>

<success_criteria>

- All tasks completed
- TicketDraft has: title, problem, AC[], constraints[], evidence_links[]
- AgentState has: phase enum, draft, state_version, step_count
- Patch-style updates work correctly
- Evidence tracking works
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-core/05-01-SUMMARY.md`
</output>
