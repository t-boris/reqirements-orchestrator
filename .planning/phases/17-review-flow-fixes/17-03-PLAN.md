---
phase: 17-review-flow-fixes
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - src/slack/handlers.py
  - docs/SLACK_APP_SETUP.md
  - tests/test_channel_join.py
autonomous: false
---

<objective>
Debug and verify channel join welcome message posting.

Purpose: Determine why welcome message isn't appearing in channel root when bot joins. Add debugging logs, verify handler code, and document Slack app configuration requirements.

Output:
- Enhanced logging in member_joined_channel handler
- Documentation of required Slack app event subscriptions and scopes
- Test instructions for manual verification
- Checkpoint for user to verify Slack app configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-review-flow-fixes/17-CONTEXT.md
@.planning/phases/12-onboarding-ux/12-01-SUMMARY.md
@src/slack/handlers.py
@src/slack/router.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Enhance logging in member_joined_channel handler</name>
  <files>src/slack/handlers.py</files>
  <action>
Update the `handle_member_joined_channel` function (lines 2945-2968) to add more detailed logging:

```python
def handle_member_joined_channel(event: dict, client: WebClient, context: BoltContext):
    """Handle member_joined_channel event - post pinned quick-reference.

    Only triggers when the bot itself joins a channel.
    Posts the welcome message and pins it immediately.

    Pattern: Sync wrapper delegates to async.
    """
    # Log the raw event for debugging
    logger.info(
        "member_joined_channel event received",
        extra={
            "event": event,
            "user": event.get("user"),
            "channel": event.get("channel"),
            "bot_user_id": context.get("bot_user_id"),
        }
    )

    # Only respond to bot's own join
    user = event.get("user")
    bot_user_id = context.get("bot_user_id")

    if user != bot_user_id:
        logger.info(
            "Ignoring member join - not the bot",
            extra={"user": user, "bot_user_id": bot_user_id}
        )
        return  # Not our join, ignore

    channel = event.get("channel")

    logger.info(
        "Bot joined channel, posting quick-reference",
        extra={"channel": channel, "channel_type": event.get("channel_type")}
    )

    _run_async(_handle_channel_join_async(channel, client))
```

Also enhance the async handler:
```python
async def _handle_channel_join_async(channel: str, client: WebClient):
    """Async handler for channel join - posts and pins welcome message."""
    from src.slack.blocks import build_welcome_blocks

    logger.info(
        "Building welcome blocks",
        extra={"channel": channel}
    )

    blocks = build_welcome_blocks()

    try:
        # Post the quick-reference message
        logger.info(
            "Posting welcome message to channel",
            extra={"channel": channel, "has_blocks": bool(blocks)}
        )

        result = client.chat_postMessage(
            channel=channel,
            text="MARO is active in this channel",
            blocks=blocks,
            # EXPLICITLY no thread_ts - post to channel root
        )

        message_ts = result.get("ts")

        logger.info(
            "Welcome message posted successfully",
            extra={"channel": channel, "message_ts": message_ts}
        )

        # Pin the message
        if message_ts:
            try:
                logger.info(
                    "Attempting to pin welcome message",
                    extra={"channel": channel, "message_ts": message_ts}
                )

                client.pins_add(
                    channel=channel,
                    timestamp=message_ts,
                )

                logger.info(
                    "Pinned welcome message successfully",
                    extra={"channel": channel, "message_ts": message_ts}
                )
            except Exception as e:
                # May fail if bot lacks pin permission - non-blocking
                logger.warning(
                    f"Could not pin welcome message: {e}",
                    extra={"channel": channel, "error": str(e)}
                )

    except Exception as e:
        logger.error(
            f"Failed to post welcome message: {e}",
            extra={"channel": channel, "error": str(e)},
            exc_info=True
        )
```

These enhanced logs will help debug:
- Whether event is firing at all
- Whether user ID matches bot ID
- Whether message posting succeeds
- Whether pinning succeeds or fails
  </action>
  <verify>
1. Python syntax: `python -m py_compile src/slack/handlers.py`
2. Check for new log statements: `grep -c "member_joined_channel event received" src/slack/handlers.py`
3. Verify no thread_ts in postMessage: `grep -A5 "chat_postMessage" src/slack/handlers.py | grep "channel.*channel"`
  </verify>
  <done>Enhanced logging added to member_joined_channel handler with detailed event tracking, post verification, and pin status</done>
</task>

<task type="auto">
  <name>Task 2: Create Slack app setup documentation</name>
  <files>docs/SLACK_APP_SETUP.md</files>
  <action>
Create comprehensive documentation for Slack app configuration:

```markdown
# Slack App Setup - MARO Bot

## Required Event Subscriptions

Navigate to: **Event Subscriptions** → **Subscribe to bot events**

Add these event subscriptions:

| Event Name | Purpose | Phase |
|------------|---------|-------|
| `app_mention` | Bot responds when @mentioned | 1 |
| `message.channels` | Bot sees messages in channels | 4 |
| `message.groups` | Bot sees messages in private channels | 4 |
| `message.im` | Bot sees DMs | 4 |
| `message.mpim` | Bot sees multi-person DMs | 4 |
| `member_joined_channel` | **Bot posts welcome when joining channel** | **12** |

### Missing Event Symptom

If `member_joined_channel` is NOT subscribed:
- Event will never fire
- No logs will show "member_joined_channel event received"
- Welcome message won't post when bot joins channels

## Required Bot Token Scopes

Navigate to: **OAuth & Permissions** → **Bot Token Scopes**

| Scope | Purpose | Phase |
|-------|---------|-------|
| `app_mentions:read` | Read @mentions | 1 |
| `channels:history` | Read channel messages | 4 |
| `channels:read` | List channels | 4 |
| `chat:write` | Send messages | 1 |
| `commands` | Handle slash commands | 6 |
| `groups:history` | Read private channel messages | 4 |
| `im:history` | Read DM messages | 4 |
| `mpim:history` | Read multi-person DM messages | 4 |
| `pins:write` | **Pin welcome messages** | **12** |
| `users:read` | Read user info | 7 |

### Missing Scope Symptom

If `pins:write` is missing:
- Welcome message will post successfully
- Pin attempt will fail with permission error
- Log: "Could not pin welcome message: missing_scope"

## Testing Welcome Message

### 1. Remove bot from test channel
```
In Slack: /remove @maro
```

### 2. Check deployment logs are ready
```bash
gcloud compute ssh maro-server --zone=us-central1-a \
  --command='cd /opt/maro && docker-compose logs -f bot'
```

### 3. Re-invite bot to channel
```
In Slack: /invite @maro
```

### 4. Expected logs
```
INFO - member_joined_channel event received
INFO - Bot joined channel, posting quick-reference
INFO - Building welcome blocks
INFO - Posting welcome message to channel
INFO - Welcome message posted successfully
INFO - Attempting to pin welcome message
INFO - Pinned welcome message successfully
```

### 5. Expected Slack behavior
- Message appears in **channel root** (not in a thread)
- Message is **pinned** at top of channel
- Message contains:
  - "MARO is active in this channel"
  - Usage examples
  - Command reference

## Troubleshooting

### Event never fires
**Symptom:** No logs at all when bot joins channel
**Cause:** `member_joined_channel` not in Event Subscriptions
**Fix:** Add event subscription, reinstall app to workspace

### Message posts but not pinned
**Symptom:** Log shows "Could not pin welcome message: missing_scope"
**Cause:** `pins:write` scope missing
**Fix:** Add scope, reinstall app to workspace

### Message posts to thread instead of channel
**Symptom:** Message appears in thread, not channel root
**Cause:** Handler code incorrectly includes thread_ts
**Fix:** Code already correct (no thread_ts in chat_postMessage call)

## After Configuration Changes

1. **Reinstall app:** Changes to events/scopes require reinstalling to workspace
2. **Restart bot:** `docker-compose restart bot`
3. **Test:** Remove and re-add bot to test channel
```
  </action>
  <verify>
1. File created: `ls docs/SLACK_APP_SETUP.md`
2. Contains member_joined_channel: `grep "member_joined_channel" docs/SLACK_APP_SETUP.md`
3. Contains pins:write: `grep "pins:write" docs/SLACK_APP_SETUP.md`
  </verify>
  <done>Comprehensive Slack app setup documentation created with event subscriptions, scopes, testing instructions, and troubleshooting guide</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced logging for channel join events and Slack app configuration documentation</what-built>
  <how-to-verify>
1. **Verify current Slack app configuration:**
   - Go to https://api.slack.com/apps
   - Select your MARO app
   - Navigate to **Event Subscriptions**
   - Check if `member_joined_channel` is listed under "Subscribe to bot events"
   - Navigate to **OAuth & Permissions**
   - Check if `pins:write` is listed under "Bot Token Scopes"

2. **Test the welcome message:**
   - In a test Slack channel, remove the bot: `/remove @maro`
   - Open terminal and watch logs:
     ```bash
     gcloud compute ssh maro-server --zone=us-central1-a \
       --command='cd /opt/maro && docker-compose logs -f bot | grep "member_joined"'
     ```
   - In Slack, re-invite the bot: `/invite @maro`
   - Watch for logs showing event received and message posted

3. **Expected outcomes:**
   - If event subscription exists: Logs show "member_joined_channel event received" and message posts to channel root
   - If event subscription missing: No logs at all (need to add event and reinstall app)
   - If pins:write missing: Message posts but log shows pin error (need to add scope and reinstall)

4. **Report findings:**
   - "Event fires correctly, message posted and pinned" → Working
   - "No logs when bot joins" → Need to add event subscription
   - "Message posts but pin fails" → Need to add pins:write scope
   - "Message in thread not channel" → Code issue (should not happen with current code)
  </how-to-verify>
  <resume-signal>Report what you observed during testing: event status, message location, pin status</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Add unit test for welcome message handler</name>
  <files>tests/test_channel_join.py</files>
  <action>
Create test file to verify handler behavior:

```python
import pytest
from unittest.mock import Mock, MagicMock, patch
from src.slack.handlers import handle_member_joined_channel

class TestChannelJoinHandler:
    """Test member_joined_channel event handler."""

    def test_ignores_non_bot_user_join(self):
        """Handler ignores when non-bot user joins channel."""
        event = {
            "user": "U123456",  # Some user
            "channel": "C123456",
        }
        context = MagicMock()
        context.get.return_value = "B999999"  # Bot user ID different
        client = Mock()

        handle_member_joined_channel(event, client, context)

        # Should NOT call chat_postMessage
        client.chat_postMessage.assert_not_called()

    def test_posts_message_when_bot_joins(self):
        """Handler posts welcome message when bot joins channel."""
        bot_user_id = "B123456"
        event = {
            "user": bot_user_id,  # Bot joining
            "channel": "C123456",
        }
        context = MagicMock()
        context.get.return_value = bot_user_id
        client = Mock()

        # Mock successful post
        client.chat_postMessage.return_value = {"ts": "1234567890.123456"}

        with patch('src.slack.handlers._run_async') as mock_run_async:
            handle_member_joined_channel(event, client, context)

            # Should call _run_async with the async handler
            mock_run_async.assert_called_once()

    def test_message_posts_to_channel_root_not_thread(self):
        """Welcome message posts to channel root without thread_ts."""
        # This is a code inspection test - verify chat_postMessage call
        # doesn't include thread_ts parameter

        # Read handler code
        import inspect
        from src.slack.handlers import _handle_channel_join_async

        source = inspect.getsource(_handle_channel_join_async)

        # Verify chat_postMessage doesn't include thread_ts
        assert "thread_ts" not in source or "# no thread_ts" in source.lower(), \
            "chat_postMessage should not include thread_ts to post to channel root"
```

Run tests to verify handler behavior.
  </action>
  <verify>
```bash
pytest tests/test_channel_join.py -v
```

Expected: All tests pass, specifically:
- test_ignores_non_bot_user_join PASSED
- test_posts_message_when_bot_joins PASSED
- test_message_posts_to_channel_root_not_thread PASSED
  </verify>
  <done>3 unit tests added for channel join handler covering event filtering, message posting, and channel root verification</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Enhanced logging added to member_joined_channel handler
- [ ] SLACK_APP_SETUP.md documentation created
- [ ] User verified Slack app configuration and tested welcome message
- [ ] Unit tests for channel join handler pass
- [ ] No Python syntax errors
</verification>

<success_criteria>
- All tasks completed
- Logging shows whether event fires and where message posts
- Documentation provides clear setup instructions
- User verified Slack app event subscription status
- Tests confirm handler behavior
- Welcome message posts to channel root (not thread) when properly configured
</success_criteria>

<output>
After completion, create `.planning/phases/17-review-flow-fixes/17-03-SUMMARY.md`
</output>
