---
phase: 17-review-flow-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/handlers.py
  - src/graph/intent.py
  - tests/test_intent_review_context.py
autonomous: true
---

<objective>
Fix intent classification to use review context for continuation detection.

Purpose: Prevent misclassification of user responses during review conversations. "I like architecture" and "propose default" should be recognized as continuations when review_context exists.

Output:
- Intent classification receives has_review_context parameter
- REVIEW_CONTINUATION patterns include "user deferring to bot" pattern
- Handlers pass review_context status to classifier
- Tests verify continuation detection works correctly
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-review-flow-fixes/17-CONTEXT.md
@.planning/phases/15-review-conversation-flow/15-01-SUMMARY.md
@src/graph/intent.py
@src/slack/handlers.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add "user deferring" pattern to REVIEW_CONTINUATION</name>
  <files>src/graph/intent.py</files>
  <action>
In the REVIEW_CONTINUATION_PATTERNS list (added in Phase 15), add new pattern for when user defers decision to bot:

```python
REVIEW_CONTINUATION_PATTERNS = [
    # ... existing patterns (key-value, numbered, bullet, etc.)

    # User deferring to bot - "you propose", "you decide", "suggest default"
    (r"\b(?:you\s+)?(?:propose|suggest|recommend|decide|pick|choose)\b.*(?:default|for\s+me|how\s+you\s+see)",
     "pattern: user deferring decision to bot"),

    # User asking bot for perspective
    (r"\bhow\s+(?:do\s+)?you\s+see\s+it\b",
     "pattern: asking for bot's perspective"),
]
```

These patterns should ONLY match when has_review_context=True (already handled by _check_review_continuation being called conditionally).

Also add NOT_CONTINUATION patterns to ensure explicit new requests override:
```python
NOT_CONTINUATION_PATTERNS = [
    # ... existing patterns

    # Explicit new topic requests
    (r"\bpropose\s+(?:new|another|different)\s+(?:architecture|approach|design)",
     "pattern: requesting new/different approach"),
]
```
  </action>
  <verify>
1. Patterns compile without regex errors: `python -c "import src.graph.intent"`
2. Test string matches:
   - "propose default" matches → REVIEW_CONTINUATION (when has_review_context=True)
   - "how you see it" matches → REVIEW_CONTINUATION (when has_review_context=True)
   - "propose new architecture" matches NOT_CONTINUATION → returns None
  </verify>
  <done>REVIEW_CONTINUATION_PATTERNS includes 2 new patterns for user deferring to bot, NOT_CONTINUATION includes new-topic override pattern</done>
</task>

<task type="auto">
  <name>Task 2: Update handler to pass has_review_context to classify_intent</name>
  <files>src/slack/handlers.py</files>
  <action>
Find the `handle_thread_message()` function (around line 200-300) where intent classification happens.

Before calling `classify_intent()`, check if state has review_context:

```python
# In handle_thread_message(), before intent classification:

# Get current state to check for active review
state = await state_store.get_state(identity.thread_ts)
has_review_context = bool(state.get("review_context"))

# Pass to classifier
intent_result = await classify_intent(
    message=latest_message,
    has_review_context=has_review_context  # ADD THIS PARAMETER
)
```

Locate where `state_store.get_state()` is already called (it should exist for context injection). If state is retrieved multiple times, consolidate to single call and reuse the state dict.

IMPORTANT: The classify_intent function signature already accepts has_review_context (added in Phase 15), so we just need to pass it from the handler.
  </action>
  <verify>
1. Python syntax check: `python -m py_compile src/slack/handlers.py`
2. Search for the change: `grep -A2 "classify_intent" src/slack/handlers.py | grep "has_review_context"`
3. Ensure state is retrieved before classify_intent call
  </verify>
  <done>Handler retrieves state and passes has_review_context=bool(state.get("review_context")) to classify_intent()</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for continuation detection</name>
  <files>tests/test_intent_review_context.py</files>
  <action>
Add new test cases to existing test file (created in Phase 15) or create new test section:

```python
import pytest
from src.graph.intent import classify_intent, IntentType

class TestReviewContinuationWithContext:
    """Test continuation patterns with has_review_context=True."""

    def test_user_defers_to_bot_propose_default(self):
        """'propose default' with review context → REVIEW_CONTINUATION."""
        result = classify_intent("propose default, how you see it", has_review_context=True)
        assert result.intent == IntentType.REVIEW_CONTINUATION
        assert "deferring" in result.reasons[0].lower()

    def test_user_asks_bot_perspective(self):
        """'how you see it' with review context → REVIEW_CONTINUATION."""
        result = classify_intent("how do you see it?", has_review_context=True)
        assert result.intent == IntentType.REVIEW_CONTINUATION

    def test_positive_response_to_review(self):
        """'I like architecture' with review context → REVIEW_CONTINUATION."""
        result = classify_intent("I like architecture", has_review_context=True)
        assert result.intent == IntentType.REVIEW_CONTINUATION

    def test_propose_default_without_context_is_not_continuation(self):
        """'propose default' WITHOUT review context → NOT continuation."""
        result = classify_intent("propose default approach", has_review_context=False)
        # Should be REVIEW or DISCUSSION, not REVIEW_CONTINUATION
        assert result.intent != IntentType.REVIEW_CONTINUATION

    def test_explicit_new_request_overrides_continuation(self):
        """'propose new architecture' EVEN WITH context → NOT continuation."""
        result = classify_intent("propose new architecture", has_review_context=True)
        # Should recognize explicit new request
        assert result.intent != IntentType.REVIEW_CONTINUATION
        # Should be REVIEW
        assert result.intent == IntentType.REVIEW

class TestBugReproduction:
    """Reproduce exact bugs from production thread."""

    def test_bug_1_i_like_architecture(self):
        """Bug #1: 'I like architecture' after review → REVIEW_CONTINUATION."""
        result = classify_intent("I like architecture", has_review_context=True)
        assert result.intent == IntentType.REVIEW_CONTINUATION, \
            "Bug #1: Should recognize positive response as continuation"

    def test_bug_3_propose_default(self):
        """Bug #3: 'propose default, how you see it' → REVIEW_CONTINUATION."""
        result = classify_intent("propose default, how you see it", has_review_context=True)
        assert result.intent == IntentType.REVIEW_CONTINUATION, \
            "Bug #3: Should not start new REVIEW when user asks bot to decide"
```

Run tests to ensure all pass.
  </action>
  <verify>
Run tests:
```bash
pytest tests/test_intent_review_context.py -v
```

Expected: All tests pass, specifically:
- test_user_defers_to_bot_propose_default PASSED
- test_user_asks_bot_perspective PASSED
- test_bug_1_i_like_architecture PASSED
- test_bug_3_propose_default PASSED
  </verify>
  <done>8 new tests added and passing, covering continuation detection with review context and bug reproduction cases</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile src/graph/intent.py` succeeds
- [ ] `python -m py_compile src/slack/handlers.py` succeeds
- [ ] `pytest tests/test_intent_review_context.py` passes all tests
- [ ] Manual test: "propose default" after review → REVIEW_CONTINUATION (not REVIEW)
</verification>

<success_criteria>
- All tasks completed
- Intent classification uses has_review_context parameter
- REVIEW_CONTINUATION patterns include user deferring patterns
- Tests reproduce and verify Bug #1 and Bug #3 fixes
- No Python syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-review-flow-fixes/17-01-SUMMARY.md`
</output>
