# Phase 13.1: Ticket Reference Handling - Context

**Gathered:** 2026-01-15
**Status:** Ready for planning

<vision>
## How This Should Work

Когда пользователь явно упоминает существующий тикет (SCRUM-XXX), MARO должен работать с этим тикетом, а не создавать новый.

### Проблема

Сообщение: `@Maro based on your architecture create subtasks for SCRUM-1111`

**Что происходит сейчас:**
1. Intent router видит "create" → TICKET flow
2. Extraction извлекает title/problem из контекста
3. Duplicate detection находит похожий тикет
4. Показывает "Possible existing ticket found" с кнопками Link/Create

**Что должно происходить:**
1. Detect ticket reference (SCRUM-1111) → специальный flow
2. Понять действие: "create subtasks for"
3. Работать с существующим тикетом напрямую

### Новый Intent: TICKET_ACTION

Помимо TICKET/REVIEW/DISCUSSION добавить:

| Intent | Trigger | Действие |
|--------|---------|----------|
| **TICKET_ACTION** | "create subtasks for SCRUM-XXX", "update SCRUM-XXX", "add to SCRUM-XXX" | Работа с существующим тикетом |

### Thread Binding Awareness

Если тред уже привязан к тикету (через ThreadBindingStore):
- Не показывать duplicate detection
- Использовать привязанный тикет как контекст
- Предлагать действия: add comment, create subtask, update fields

</vision>

<essential>
## What Must Be Nailed

1. **Ticket reference detection** — Regex для SCRUM-XXX, PROJECT-123 и т.д.
2. **Action parsing** — Понять что именно делать с тикетом (subtasks, update, comment)
3. **Thread binding check** — Не спрашивать о дубликатах если тред уже привязан

</essential>

<specifics>
## Specific Ideas

### Pattern Detection (before LLM):
```python
TICKET_ACTION_PATTERNS = [
    (r"create\s+subtasks?\s+(?:for\s+)?([A-Z]+-\d+)", "create_subtask"),
    (r"add\s+(?:to|comment\s+to)\s+([A-Z]+-\d+)", "add_comment"),
    (r"update\s+([A-Z]+-\d+)", "update_ticket"),
    (r"link\s+(?:to|this\s+to)\s+([A-Z]+-\d+)", "link_ticket"),
]
```

### IntentResult Extension:
```json
{
  "intent": "TICKET_ACTION",
  "confidence": 1.0,
  "ticket_key": "SCRUM-1111",
  "action_type": "create_subtask",
  "reasons": ["pattern: create subtasks for SCRUM-1111"]
}
```

### Thread Binding Check in Decision Node:
```python
# Before duplicate detection
binding = await thread_binding_store.get(thread_ts)
if binding:
    # Thread already bound - skip duplicate detection
    # Use bound ticket as context
    return {"action": "preview", "bound_ticket": binding.ticket_key}
```

</specifics>

<notes>
## Additional Context

### Bug: Re-linking already bound thread

User experience:
```
User: @Maro create subtasks for SCRUM-111
Bot: ✅ Linked to SCRUM-111

User: create subtasks for SCRUM-111
Bot: ✅ Linked to SCRUM-111  <-- WRONG! Should do the actual action
```

**Problem:** Bot keeps re-linking instead of recognizing:
1. Thread is already bound to SCRUM-111
2. User wants to CREATE SUBTASKS, not link

**Fix:**
```python
binding = thread_binding_store.get(thread_ts)
if binding and binding.ticket_key == mentioned_ticket:
    # Already bound to same ticket - do the ACTION, not re-link
    if action_type == "create_subtask":
        # Proceed with subtask creation
        pass
```

### DoD (Definition of Done):

- [ ] Ticket reference patterns detected (SCRUM-XXX, PROJECT-123)
- [ ] TICKET_ACTION intent with ticket_key and action_type
- [ ] Thread binding checked before duplicate detection
- [ ] If already bound to same ticket → do action, don't re-link
- [ ] Subtask creation flow (if action_type == create_subtask)
- [ ] Bound ticket shown in preview context

### Out of Scope (defer to future):
- Full subtask creation via Jira API (can be stub/preview only)
- Ticket update operations
- Comment operations

</notes>

---

*Phase: 13.1-ticket-reference*
*Context gathered: 2026-01-15*
