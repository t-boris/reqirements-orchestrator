---
phase: 13.1-ticket-reference
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graph/intent.py
  - src/graph/nodes/decision.py
  - src/slack/handlers.py
  - tests/test_intent.py
autonomous: true
---

<objective>
Handle explicit ticket references (SCRUM-XXX) and fix re-linking bug.

Purpose: When user explicitly mentions an existing ticket (e.g., "create subtasks for SCRUM-1111"), MARO should work with that ticket directly instead of creating a new ticket and asking about duplicates.

Output:
- New TICKET_ACTION intent type with ticket_key and action_type
- Ticket reference detection patterns
- Thread binding check before duplicate detection
- If already bound to same ticket → do action, don't re-link
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13.1-ticket-reference/13.1-CONTEXT.md
@src/graph/intent.py
@src/graph/nodes/decision.py
@src/slack/thread_bindings.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add TICKET_ACTION intent type and patterns</name>
  <files>src/graph/intent.py</files>
  <action>
1. Add TICKET_ACTION to IntentType enum:
   - TICKET_ACTION = "TICKET_ACTION"  # Work with existing ticket

2. Extend IntentResult with optional fields:
   - ticket_key: Optional[str] = None  # Referenced ticket (e.g., "SCRUM-1111")
   - action_type: Optional[str] = None  # Action to perform: "create_subtask", "add_comment", "update", "link"

3. Add TICKET_ACTION_PATTERNS list (checked BEFORE TICKET patterns):
   ```python
   TICKET_ACTION_PATTERNS = [
       # Format: (pattern, reason, action_type)
       (r"create\s+subtasks?\s+(?:for\s+)?([A-Z]+-\d+)", "pattern: create subtasks for ticket", "create_subtask"),
       (r"add\s+(?:subtasks?\s+)?to\s+([A-Z]+-\d+)", "pattern: add to ticket", "create_subtask"),
       (r"update\s+([A-Z]+-\d+)", "pattern: update ticket", "update"),
       (r"add\s+(?:comment\s+)?to\s+([A-Z]+-\d+)", "pattern: add comment to ticket", "add_comment"),
       (r"link\s+(?:this\s+)?to\s+([A-Z]+-\d+)", "pattern: link to ticket", "link"),
   ]
   ```

4. Update classify_intent_patterns() to check TICKET_ACTION_PATTERNS:
   - Check after NEGATION but before TICKET patterns
   - Extract ticket_key from regex capture group
   - Return IntentResult with intent=TICKET_ACTION, ticket_key, action_type

5. Update _llm_classify() prompt to handle TICKET_ACTION:
   - Add TICKET_ACTION to classification options
   - Extract ticket reference if mentioned
  </action>
  <verify>python -c "from src.graph.intent import IntentType; print(IntentType.TICKET_ACTION)"</verify>
  <done>TICKET_ACTION enum value exists, patterns return IntentResult with ticket_key and action_type</done>
</task>

<task type="auto">
  <name>Task 2: Check thread binding before duplicate detection</name>
  <files>src/graph/nodes/decision.py</files>
  <action>
1. Import thread binding store at top:
   - from src.slack.thread_bindings import get_binding_store

2. Add thread binding check at START of decision_node():
   - Get thread_ts from state (need to add to state if not present)
   - Get channel_id from state
   - Check if thread is already bound: binding = await binding_store.get_binding(channel_id, thread_ts)

3. If thread is bound:
   - Skip duplicate detection entirely
   - Return preview action with bound_ticket info in decision_result:
     ```python
     return {
         "decision_result": DecisionResult(
             action="preview",
             reason=f"Thread bound to {binding.issue_key}",
             bound_ticket=binding.issue_key,  # Add this field to DecisionResult
         ).model_dump(),
     }
     ```

4. Add bound_ticket field to DecisionResult:
   - bound_ticket: Optional[str] = None  # Existing ticket this thread is bound to

5. Thread context availability:
   - thread_ts and channel_id should come from AgentState
   - Check if they exist in state, skip binding check if not available
  </action>
  <verify>Read the decision_node function and verify binding check is at the top</verify>
  <done>Thread binding checked before duplicate detection, bound threads skip dedup</done>
</task>

<task type="auto">
  <name>Task 3: Handle TICKET_ACTION in handlers</name>
  <files>src/slack/handlers.py</files>
  <action>
1. In the intent routing section (where TICKET/REVIEW/DISCUSSION are handled):
   - Add case for TICKET_ACTION intent

2. For TICKET_ACTION with action_type == "create_subtask":
   - If thread already bound to the SAME ticket_key → proceed with subtask context (don't re-link)
   - If thread not bound → bind it to ticket_key first, then provide subtask context
   - Response: "Working on subtasks for {ticket_key}. What subtasks should I create?"

3. For TICKET_ACTION with action_type == "link":
   - Normal link flow (existing behavior)

4. For TICKET_ACTION with action_type in ("update", "add_comment"):
   - Stub response: "I can help with {action_type} for {ticket_key}. (Full implementation coming soon)"

5. Key fix for re-linking bug:
   ```python
   binding = await binding_store.get_binding(channel_id, thread_ts)
   if binding and binding.issue_key == intent_result.get("ticket_key"):
       # Already bound to same ticket - do the ACTION, not re-link
       if action_type == "create_subtask":
           # Proceed with subtask creation context
           pass
   ```
  </action>
  <verify>Grep for "TICKET_ACTION" in handlers.py</verify>
  <done>TICKET_ACTION intent handled, re-linking bug fixed for same-ticket case</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for ticket reference patterns</name>
  <files>tests/test_intent.py</files>
  <action>
1. Add test cases for TICKET_ACTION patterns:
   ```python
   @pytest.mark.parametrize("message,expected_intent,expected_ticket,expected_action", [
       # Subtask creation
       ("create subtasks for SCRUM-1111", IntentType.TICKET_ACTION, "SCRUM-1111", "create_subtask"),
       ("create subtask for PROJ-123", IntentType.TICKET_ACTION, "PROJ-123", "create_subtask"),
       ("add subtasks to SCRUM-999", IntentType.TICKET_ACTION, "SCRUM-999", "create_subtask"),
       # Update
       ("update SCRUM-1111", IntentType.TICKET_ACTION, "SCRUM-1111", "update"),
       # Link
       ("link this to SCRUM-1111", IntentType.TICKET_ACTION, "SCRUM-1111", "link"),
       # Comment
       ("add comment to PROJ-456", IntentType.TICKET_ACTION, "PROJ-456", "add_comment"),
   ])
   def test_ticket_action_patterns(message, expected_intent, expected_ticket, expected_action):
       result = classify_intent_patterns(message)
       assert result is not None
       assert result.intent == expected_intent
       assert result.ticket_key == expected_ticket
       assert result.action_type == expected_action
   ```

2. Add test that TICKET_ACTION takes priority over TICKET:
   - "create subtasks for SCRUM-1111" should NOT match "create" → TICKET
   - It should match TICKET_ACTION instead

3. Add test for ticket key formats:
   - SCRUM-1111, PROJ-123, ABC-1 should all work
   - lowercase versions should NOT match (Jira keys are uppercase)
  </action>
  <verify>pytest tests/test_intent.py -v</verify>
  <done>Tests pass for all TICKET_ACTION patterns and edge cases</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_intent.py -v` passes all tests
- [ ] `python -c "from src.graph.intent import IntentType; print(IntentType.TICKET_ACTION)"` works
- [ ] Manual test: Message "create subtasks for SCRUM-XXX" returns TICKET_ACTION intent
- [ ] No Python syntax errors or import issues
</verification>

<success_criteria>
- TICKET_ACTION intent type exists with ticket_key and action_type
- Pattern matching extracts ticket references (SCRUM-XXX format)
- Thread binding checked before duplicate detection
- Re-linking bug fixed: same-ticket action doesn't re-link
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-ticket-reference/13.1-01-SUMMARY.md`
</output>
