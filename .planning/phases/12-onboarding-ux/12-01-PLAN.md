---
phase: 12-onboarding-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/slack/router.py, src/slack/handlers.py, src/slack/blocks.py]
autonomous: true
---

<objective>
Implement channel join handler with pinned quick-reference message.

Purpose: When MARO joins a channel, post and pin a quick-reference message that serves as "installation instructions" - not a greeting, but information.
Output: Pinned message appears when bot joins channel, once per channel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-onboarding-ux/12-CONTEXT.md

@src/slack/router.py
@src/slack/handlers.py
@src/slack/blocks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add member_joined_channel event handler registration</name>
  <files>src/slack/router.py</files>
  <action>
Add event registration for `member_joined_channel` in `register_handlers()`.

Import the handler at the top:
```python
from src.slack.handlers import (
    # ... existing imports ...
    handle_member_joined_channel,
)
```

Add event registration after `app.event("message")`:
```python
# Channel join - post pinned quick-reference (Phase 12)
app.event("member_joined_channel")(handle_member_joined_channel)
```

Update the logger.info at the end to include `member_joined_channel`.
  </action>
  <verify>python -c "from src.slack.router import register_handlers; print('OK')"</verify>
  <done>member_joined_channel event registered in router</done>
</task>

<task type="auto">
  <name>Task 2: Create welcome message blocks builder</name>
  <files>src/slack/blocks.py</files>
  <action>
Add function to build the quick-reference message blocks.

```python
def build_welcome_blocks() -> list[dict]:
    """Build pinned quick-reference message for channel join.

    This is installation instructions, not a greeting.
    Posted once when MARO joins a channel.
    """
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*MARO is active in this channel*\n\nI help turn discussions into Jira tickets and keep context in sync."
            }
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*Try:*\n• `@MARO Create a Jira story for...`\n• `@MARO What do you think about this?`\n• `@MARO Review this as security`"
            }
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*Commands:*\n• `/maro status` – show channel settings\n• `/maro help` – quick help\n• `/persona pm | architect | security`"
            }
        },
        {
            "type": "context",
            "elements": [
                {
                    "type": "mrkdwn",
                    "text": "I stay silent unless you mention me."
                }
            ]
        }
    ]
```

Text from 12-CONTEXT.md vision section.
  </action>
  <verify>python -c "from src.slack.blocks import build_welcome_blocks; print(build_welcome_blocks())"</verify>
  <done>build_welcome_blocks function exists in blocks.py</done>
</task>

<task type="auto">
  <name>Task 3: Implement channel join handler</name>
  <files>src/slack/handlers.py</files>
  <action>
Add handler for member_joined_channel event.

```python
def handle_member_joined_channel(event: dict, client: WebClient, context: BoltContext):
    """Handle member_joined_channel event - post pinned quick-reference.

    Only triggers when the bot itself joins a channel.
    Posts the welcome message and pins it immediately.

    Pattern: Sync wrapper delegates to async.
    """
    # Only respond to bot's own join
    user = event.get("user")
    bot_user_id = context.get("bot_user_id")

    if user != bot_user_id:
        return  # Not our join, ignore

    channel = event.get("channel")

    logger.info(
        "Bot joined channel, posting quick-reference",
        extra={"channel": channel}
    )

    _run_async(_handle_channel_join_async(channel, client))


async def _handle_channel_join_async(channel: str, client: WebClient):
    """Async handler for channel join - posts and pins welcome message."""
    from src.slack.blocks import build_welcome_blocks

    blocks = build_welcome_blocks()

    try:
        # Post the quick-reference message
        result = client.chat_postMessage(
            channel=channel,
            text="MARO is active in this channel",
            blocks=blocks,
        )

        message_ts = result.get("ts")

        # Pin the message
        if message_ts:
            try:
                client.pins_add(
                    channel=channel,
                    timestamp=message_ts,
                )
                logger.info(
                    "Pinned welcome message",
                    extra={"channel": channel, "message_ts": message_ts}
                )
            except Exception as e:
                # May fail if bot lacks pin permission - non-blocking
                logger.warning(f"Could not pin welcome message: {e}")

    except Exception as e:
        logger.error(f"Failed to post welcome message: {e}", exc_info=True)
```

Key behaviors from CONTEXT.md:
- Post to channel (not thread)
- Pin immediately
- One-time per channel join
- No "hello" greeting, just information
  </action>
  <verify>python -c "from src.slack.handlers import handle_member_joined_channel; print('OK')"</verify>
  <done>Channel join handler posts and pins quick-reference message</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Bot joining channel triggers handle_member_joined_channel
- [ ] Welcome message is posted to channel (not thread)
- [ ] Message is pinned (or logs warning if no permission)
- [ ] Other users joining channel do NOT trigger welcome message
- [ ] Message content matches CONTEXT.md vision
</verification>

<success_criteria>
- All tasks completed
- Bot join posts pinned quick-reference
- Other user joins are ignored
- Non-blocking on pin failure
</success_criteria>

<output>
After completion, create `.planning/phases/12-onboarding-ux/12-01-SUMMARY.md`
</output>
