---
phase: 21-jira-sync
plan: 03
type: execute
wave: 2
depends_on: [21-01, 21-02]
files_modified: [src/graph/nodes/jira_command.py, src/graph/intent.py, src/slack/handlers/dispatch.py]
autonomous: true
---

<objective>
Implement natural language Jira commands.

Purpose: Users can say "change the priority of that ticket to high" and MARO figures out which ticket from context.
Output: Natural language parsing for edit/update/delete operations on tracked issues.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-jira-sync/21-CONTEXT.md

@src/graph/intent.py
@src/graph/nodes/extraction.py
@src/slack/channel_tracker.py (from 21-01)
@src/jira/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JIRA_COMMAND intent classification</name>
  <files>src/graph/intent.py</files>
  <action>
Add new intent type for Jira management commands.

In Intent enum:
```python
JIRA_COMMAND = "jira_command"  # Edit/update/delete Jira issues
```

Update intent classification prompt to detect:
- "change the priority of SCRUM-123 to high"
- "update that ticket's status to Done"
- "delete SCRUM-456"
- "change the assignee to @john"
- "set the status of the auth ticket to In Progress"

Key signals:
- Verbs: change, update, set, modify, edit, delete, remove, close
- Fields: priority, status, assignee, description, summary, labels
- Target: issue key (SCRUM-XXX) or reference ("that ticket", "the auth ticket", "it")

Classification output:
```json
{
    "intent": "jira_command",
    "command_type": "update|delete",
    "target": "SCRUM-123" | "contextual",
    "field": "priority|status|assignee|etc",
    "value": "high|Done|@john|etc"
}
```
  </action>
  <verify>Intent classifier detects "change priority of SCRUM-123 to high"</verify>
  <done>JIRA_COMMAND intent detected for edit/update/delete phrases</done>
</task>

<task type="auto">
  <name>Task 2: Create JiraCommandNode for command execution</name>
  <files>src/graph/nodes/jira_command.py</files>
  <action>
Create graph node to handle JIRA_COMMAND intent.

Class: JiraCommandNode
Method: process(state) -> state

Logic:
1. Extract command details from state:
   - command_type: "update" or "delete"
   - target: issue key or "contextual"
   - field: which field to change
   - value: new value

2. Resolve target if contextual:
   - Check thread binding for linked issue
   - Check channel tracker for recently discussed issue
   - If ambiguous, ask user: "Which ticket? SCRUM-123, SCRUM-124, or SCRUM-125?"

3. Validate operation:
   - Verify issue exists in Jira
   - Verify user has permission (future: check Jira permissions)
   - For delete: ALWAYS require confirmation

4. Build confirmation prompt:
   - update: "Change {field} of {ticket} from '{old}' to '{new}'?"
   - delete: "Are you sure you want to delete {ticket}? This cannot be undone."

5. Return state with:
   - action: "jira_command_confirm"
   - command_details: {target, field, old_value, new_value, command_type}

Target resolution priority:
1. Explicit key in message (SCRUM-XXX)
2. Thread binding (if in thread with linked ticket)
3. Single tracked issue in channel
4. Most recently mentioned issue in conversation
5. Ask user if ambiguous
  </action>
  <verify>JiraCommandNode resolves "that ticket" to actual key</verify>
  <done>JiraCommandNode processes commands and resolves contextual targets</done>
</task>

<task type="auto">
  <name>Task 3: Add command confirmation and execution</name>
  <files>src/slack/handlers/dispatch.py, src/slack/handlers/jira_commands.py</files>
  <action>
Add dispatch handler for jira_command_confirm action.

In dispatch.py, add handler:
```python
elif action == "jira_command_confirm":
    await _handle_jira_command_confirm(result, identity, client)
```

Create src/slack/handlers/jira_commands.py:

Function: handle_jira_command_confirm
1. Build confirmation blocks with buttons:
   ```
   Change priority of SCRUM-123 from "Medium" to "High"?
   [Confirm] [Cancel]
   ```

2. For delete commands, add warning styling:
   ```
   ⚠️ Delete SCRUM-123: "User authentication flow"?
   This cannot be undone.
   [Delete] [Cancel]
   ```

Button handlers (add to router.py):
- jira_command_execute: Execute the confirmed command
- jira_command_cancel: Cancel and acknowledge

Execution:
- Update: Call JiraService.update_issue(key, {field: value})
- Delete: Call JiraService.delete_issue(key)
- Post confirmation: "Updated SCRUM-123: priority → High"
- Refresh board if exists
  </action>
  <verify>"change priority to high" shows confirmation, confirm executes</verify>
  <done>Natural language commands work with confirmation flow</done>
</task>

<task type="auto">
  <name>Task 4: Add field value normalization</name>
  <files>src/graph/nodes/jira_command.py</files>
  <action>
Normalize natural language values to Jira field values.

Field normalizations:
- Priority: "high" → "High", "urgent" → "Highest", "low" → "Low"
- Status: "done" → "Done", "in progress" → "In Progress", "todo" → "To Do"
- Assignee: "@john" → look up Jira accountId from Slack user

Create normalization helpers:
```python
def normalize_priority(value: str) -> str:
    mapping = {
        "urgent": "Highest",
        "high": "High",
        "medium": "Medium",
        "low": "Low",
        "lowest": "Lowest",
    }
    return mapping.get(value.lower(), value)

def normalize_status(value: str, project_statuses: list) -> str:
    # Match against available statuses in project
    value_lower = value.lower().replace(" ", "")
    for status in project_statuses:
        if status.lower().replace(" ", "") == value_lower:
            return status
    return value

async def resolve_assignee(slack_mention: str, jira_service) -> Optional[str]:
    # @john → search Jira users → return accountId
    pass
```

For status changes, fetch available transitions first:
- GET /rest/api/3/issue/{key}/transitions
- Match requested status to available transition
- Use transition ID if found
  </action>
  <verify>"set to urgent" normalizes to priority "Highest"</verify>
  <done>Field values normalized from natural language to Jira values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "change priority of SCRUM-123 to high" detected as JIRA_COMMAND
- [ ] "update that ticket's status" resolves from thread context
- [ ] Confirmation dialog appears before changes
- [ ] Changes applied to Jira after confirm
- [ ] Delete requires explicit confirmation with warning
- [ ] Board refreshes after changes
</verification>

<success_criteria>

- All tasks completed
- Intent classifier detects Jira commands
- Contextual target resolution works
- Confirmation flow for all changes
- Delete has extra warning
- Field values normalized correctly
</success_criteria>

<output>
After completion, create `.planning/phases/21-jira-sync/21-03-SUMMARY.md`
</output>
