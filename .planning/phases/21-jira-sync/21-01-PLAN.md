---
phase: 21-jira-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/slack/channel_tracker.py, src/slack/handlers/commands.py, src/slack/router.py]
autonomous: true
---

<objective>
Create channel-level Jira issue tracking store.

Purpose: Foundation for all sync features - MARO needs to know which Jira issues are relevant to each channel.
Output: ChannelIssueTracker with PostgreSQL persistence, /maro track and /maro untrack commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-jira-sync/21-CONTEXT.md

@src/slack/thread_bindings.py
@src/slack/handlers/commands.py
@src/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChannelIssueTracker with PostgreSQL persistence</name>
  <files>src/slack/channel_tracker.py, src/db/models.py</files>
  <action>
Create ChannelIssueTracker class that stores channel → Jira issue mappings in PostgreSQL.

Model: ChannelTrackedIssue
- channel_id: str (Slack channel ID)
- issue_key: str (e.g., "SCRUM-123")
- tracked_at: datetime
- tracked_by: str (Slack user ID)
- last_synced_at: Optional[datetime]
- last_jira_status: Optional[str]
- last_jira_summary: Optional[str]

Methods:
- track(channel_id, issue_key, tracked_by) -> TrackedIssue
- untrack(channel_id, issue_key) -> bool
- get_tracked_issues(channel_id) -> list[TrackedIssue]
- is_tracked(channel_id, issue_key) -> bool
- update_sync_status(channel_id, issue_key, status, summary) -> None

Auto-track: When MARO creates a Jira ticket in a channel, automatically add to tracker.
Auto-track: When user links to existing ticket via duplicate flow, add to tracker.

Use SQLAlchemy async session pattern from existing models.
  </action>
  <verify>Python imports without errors, model migration runs</verify>
  <done>ChannelIssueTracker persists tracked issues to PostgreSQL</done>
</task>

<task type="auto">
  <name>Task 2: Add /maro track and /maro untrack commands</name>
  <files>src/slack/handlers/commands.py, src/slack/router.py</files>
  <action>
Add subcommands to /maro:
- `/maro track SCRUM-123` - Add issue to channel's tracked list
- `/maro track SCRUM-123 SCRUM-124 SCRUM-125` - Track multiple
- `/maro untrack SCRUM-123` - Remove from tracked list
- `/maro tracked` - List all tracked issues for this channel

In handle_maro_command:
1. Parse subcommand (track/untrack/tracked)
2. Extract issue keys from args
3. Validate keys exist in Jira (call JiraService.get_issue)
4. Add/remove from ChannelIssueTracker
5. Respond with confirmation

Response format for /maro tracked:
```
Tracked Jira issues in #channel-name:
• SCRUM-123: User authentication flow (Open)
• SCRUM-124: Database migration (In Progress)
• SCRUM-125: API documentation (Done)
```

Error handling:
- Unknown issue key: "SCRUM-999 not found in Jira"
- Already tracked: "SCRUM-123 is already tracked in this channel"
- Not tracked: "SCRUM-123 is not tracked in this channel"
  </action>
  <verify>/maro track SCRUM-123 responds with confirmation</verify>
  <done>Track/untrack commands work, /maro tracked shows list</done>
</task>

<task type="auto">
  <name>Task 3: Auto-track on ticket creation and linking</name>
  <files>src/slack/handlers/dispatch.py, src/slack/handlers/duplicates.py</files>
  <action>
Hook into existing ticket creation and linking flows to auto-track:

1. In dispatch.py after successful ticket creation:
   - After JiraService.create_issue succeeds
   - Call ChannelIssueTracker.track(channel_id, issue.key, user_id)
   - Log: "Auto-tracked {issue.key} in channel {channel_id}"

2. In duplicates.py after linking to existing:
   - In handle_link_duplicate after successful link
   - Call ChannelIssueTracker.track(channel_id, linked_key, user_id)
   - Log: "Auto-tracked {linked_key} in channel {channel_id}"

3. In stories.py after creating stories under epic:
   - Track each created story key
   - Already have the channel_id from body

This ensures all Jira issues MARO interacts with are automatically tracked for sync.
  </action>
  <verify>Create ticket in Slack, check /maro tracked shows it</verify>
  <done>New tickets and linked tickets auto-tracked</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.slack.channel_tracker import ChannelIssueTracker"` works
- [ ] Database migration creates channel_tracked_issues table
- [ ] /maro track SCRUM-XXX works in Slack
- [ ] /maro tracked lists issues
- [ ] Creating a ticket auto-adds to tracked list
</verification>

<success_criteria>

- All tasks completed
- ChannelIssueTracker persists to PostgreSQL
- /maro track, untrack, tracked commands work
- Auto-tracking on create/link works
</success_criteria>

<output>
After completion, create `.planning/phases/21-jira-sync/21-01-SUMMARY.md`
</output>
