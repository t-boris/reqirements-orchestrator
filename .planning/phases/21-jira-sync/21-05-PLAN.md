---
phase: 21-jira-sync
plan: 05
type: execute
wave: 3
depends_on: [21-01, 21-04]
files_modified: [src/slack/handlers/dispatch.py, src/slack/handlers/review.py, src/slack/decision_linker.py]
autonomous: true
---

<objective>
Auto-update Jira when architecture decisions are approved.

Purpose: When a decision is approved in Slack (Phase 14 flow), automatically update the related Jira ticket with the decision.
Output: DecisionLinker that connects approved decisions to tracked Jira issues and updates them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-jira-sync/21-CONTEXT.md

@src/slack/handlers/dispatch.py
@src/slack/handlers/review.py
@src/slack/channel_tracker.py (from 21-01)
@src/slack/sync_engine.py (from 21-04)
@src/jira/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DecisionLinker service</name>
  <files>src/slack/decision_linker.py</files>
  <action>
Create DecisionLinker service that connects decisions to Jira issues.

Class: DecisionLinker

Methods:
- find_related_issues(decision_topic: str, decision_text: str, channel_id: str) -> list[str]
  1. Extract explicit Jira keys from decision text (SCRUM-XXX pattern)
  2. Check thread binding if decision was in a thread
  3. Search tracked issues by keyword match (topic words vs issue summaries)
  4. Return ranked list of likely related issue keys

- format_decision_for_jira(topic: str, decision: str, approver: str, timestamp: str) -> str
  Format as Jira ADF or wiki markup:
  ```
  h3. Architecture Decision
  *Topic:* {topic}
  *Decision:* {decision}
  *Approved by:* {approver}
  *Date:* {timestamp}
  *Source:* [Slack thread|{slack_link}]
  ```

- apply_decision_to_issue(issue_key: str, decision_content: str, mode: str) -> bool
  Mode options:
  - "append_description": Add to end of description
  - "add_comment": Add as comment
  - "custom_field": Add to decision tracking field (if exists)

Configuration:
- Default mode: "add_comment" (safest)
- Can be configured per channel in ChannelConfig
  </action>
  <verify>DecisionLinker.find_related_issues returns relevant keys</verify>
  <done>DecisionLinker finds and links decisions to issues</done>
</task>

<task type="auto">
  <name>Task 2: Hook into approval flow</name>
  <files>src/slack/handlers/dispatch.py</files>
  <action>
Modify _handle_decision_approval to auto-update Jira.

After posting decision to channel:
1. Find related issues using DecisionLinker
2. If single match with high confidence: auto-update
3. If multiple matches or low confidence: ask user

Updated flow:
```python
async def _handle_decision_approval(result, identity, client):
    # ... existing decision extraction ...

    # Post decision to channel (existing)
    client.chat_postMessage(...)

    # NEW: Link to Jira
    from src.slack.decision_linker import DecisionLinker
    linker = DecisionLinker()

    related_issues = linker.find_related_issues(
        topic=topic,
        decision_text=decision_text,
        channel_id=channel_id,
    )

    if len(related_issues) == 1:
        # High confidence single match - auto-update
        issue_key = related_issues[0]
        success = await linker.apply_decision_to_issue(
            issue_key,
            linker.format_decision_for_jira(topic, decision_text, user_id, timestamp),
        )
        if success:
            client.chat_postMessage(
                channel=identity.channel_id,
                thread_ts=identity.thread_ts,
                text=f"Decision added to *{issue_key}*.",
            )
    elif related_issues:
        # Multiple matches - ask user
        await _prompt_decision_link(related_issues, topic, decision_text, identity, client)
    # else: No related issues found, decision just stays in channel
```
  </action>
  <verify>Approving decision auto-updates linked Jira ticket</verify>
  <done>Decision approval triggers Jira update</done>
</task>

<task type="auto">
  <name>Task 3: Build decision link prompt UI</name>
  <files>src/slack/handlers/dispatch.py, src/slack/router.py</files>
  <action>
Create UI for linking decisions when multiple issues match.

Function: _prompt_decision_link
```python
async def _prompt_decision_link(
    issues: list[str],
    topic: str,
    decision_text: str,
    identity: SessionIdentity,
    client: WebClient,
):
    blocks = [
        {
            "type": "section",
            "text": {"type": "mrkdwn", "text": f"Link this decision to a Jira ticket?"}
        },
        {
            "type": "section",
            "text": {"type": "mrkdwn", "text": f"*{topic}*\n{decision_text[:200]}..."}
        },
        {"type": "divider"},
        {
            "type": "section",
            "text": {"type": "mrkdwn", "text": "*Related tickets:*"}
        },
    ]

    # Add button for each issue
    for key in issues[:5]:  # Max 5 options
        blocks.append({
            "type": "section",
            "text": {"type": "mrkdwn", "text": f"â€¢ *{key}*: {issue_summary}"},
            "accessory": {
                "type": "button",
                "text": {"type": "plain_text", "text": "Link"},
                "action_id": f"link_decision_{key}",
                "value": json.dumps({"key": key, "topic": topic, "decision": decision_text}),
            }
        })

    blocks.append({
        "type": "actions",
        "elements": [
            {"type": "button", "text": {"type": "plain_text", "text": "Skip"}, "action_id": "skip_decision_link"}
        ]
    })

    client.chat_postMessage(
        channel=identity.channel_id,
        thread_ts=identity.thread_ts,
        blocks=blocks,
        text="Link decision to Jira?",
    )
```

Button handlers in router.py:
- link_decision_{key}: Apply decision to selected issue
- skip_decision_link: Acknowledge and close
  </action>
  <verify>Multiple match prompt shows options, linking works</verify>
  <done>Decision link prompt with issue selection</done>
</task>

<task type="auto">
  <name>Task 4: Add manual decision linking via button</name>
  <files>src/slack/handlers/dispatch.py, src/slack/router.py</files>
  <action>
Add "Link to Jira" button on posted decisions.

When decision is posted to channel (in decision_blocks), add optional button:
```
ðŸ“‹ Architecture Decision
Topic: {topic}
Decision: {decision}
Approved by @user

[Link to Jira Ticket]
```

Button handler: decision_link_prompt
1. Show tracked issues as options (similar to Task 3)
2. Allow selecting which ticket to add decision to
3. Or text input to specify different ticket key

This allows retroactive linking of decisions that weren't auto-linked.
  </action>
  <verify>Posted decision has "Link to Jira" button</verify>
  <done>Manual linking option on posted decisions</done>
</task>

<task type="auto">
  <name>Task 5: Add decision history to issue</name>
  <files>src/slack/decision_linker.py, src/jira/client.py</files>
  <action>
Track all decisions linked to an issue.

In DecisionLinker.apply_decision_to_issue:
1. Add decision as comment (existing)
2. Also add "decision" label to issue if not present
3. Track in ChannelDecision model (from 21-04) that it's synced

Enhanced Jira comment format:
```
h3. ðŸ“‹ Architecture Decision

*Topic:* {topic}

{color:#172B4D}{decision_text}{color}

----
_Approved by {approver} on {date}_
_[View in Slack|{thread_link}]_
```

Add JiraService method:
- add_label_if_not_exists(issue_key: str, label: str) -> bool
  Adds label without duplicating

This creates a queryable history: "label = decision" finds all tickets with decisions.
  </action>
  <verify>Linked decision adds comment and "decision" label</verify>
  <done>Decisions tracked with label and formatted comment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.slack.decision_linker import DecisionLinker"` works
- [ ] Approving decision with explicit key auto-updates Jira
- [ ] Multiple match shows selection prompt
- [ ] "Link to Jira" button appears on posted decisions
- [ ] Decision comment formatted correctly in Jira
- [ ] "decision" label added to linked issues
</verification>

<success_criteria>

- All tasks completed
- DecisionLinker finds and links related issues
- Auto-update on single match
- Selection prompt on multiple matches
- Manual linking via button
- Decisions tracked with labels in Jira
</success_criteria>

<output>
After completion, create `.planning/phases/21-jira-sync/21-05-SUMMARY.md`
</output>
