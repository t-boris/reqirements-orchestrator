---
phase: 08-global-state
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: [src/context/jira_linker.py, src/slack/handlers.py, src/slack/blocks.py]
autonomous: true
---

<objective>
Build Jira linkage with thread pins and incremental sync for channel-Jira connection.

Purpose: Connect Phase 7 (jira_create) with Phase 8 (channel index). Bot pins epic/ticket in threads.
Output: `JiraLinker` class, thread pin on epic bind/ticket create, Jira sync cursor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-global-state/08-CONTEXT.md
@.planning/phases/08-global-state/08-01-SUMMARY.md
@.planning/phases/07-jira-integration/07-01-SUMMARY.md
@.planning/phases/07-jira-integration/07-02-SUMMARY.md

@src/jira/client.py
@src/slack/handlers.py
@src/slack/blocks.py
@src/slack/binding.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JiraLinker class</name>
  <files>src/context/jira_linker.py, src/context/__init__.py</files>
  <action>
Create src/context/jira_linker.py:

```python
"""Jira linkage for channel context - connects threads to Jira issues."""
import logging
from dataclasses import dataclass
from datetime import datetime, timezone
from typing import Optional

from slack_sdk import WebClient

from src.jira.client import JiraService
from src.jira.types import JiraIssue
from src.config.settings import get_settings

logger = logging.getLogger(__name__)


@dataclass
class ThreadJiraLink:
    """Link between Slack thread and Jira issue."""
    channel_id: str
    thread_ts: str
    epic_key: Optional[str] = None
    ticket_key: Optional[str] = None
    pin_ts: Optional[str] = None  # Timestamp of pinned message


class JiraLinker:
    """Manages Slack thread <-> Jira issue linkage.

    Handles:
    - Pinning summary message in thread on epic bind
    - Updating pin when ticket created
    - Adding Slack permalink to Jira description
    """

    def __init__(self, slack_client: WebClient, jira_service: JiraService) -> None:
        self._slack = slack_client
        self._jira = jira_service

    async def on_epic_bound(
        self,
        channel_id: str,
        thread_ts: str,
        epic_key: str,
        epic_summary: str,
    ) -> ThreadJiraLink:
        """Called when thread is bound to an epic.

        Posts and pins a summary message: "Epic: PROJ-123 | Epic Title"

        Args:
            channel_id: Slack channel.
            thread_ts: Thread root timestamp.
            epic_key: Jira epic key (e.g., PROJ-123).
            epic_summary: Epic summary/title.

        Returns:
            ThreadJiraLink with pin_ts set.
        """
        settings = get_settings()
        epic_url = f"{settings.jira_url}/browse/{epic_key}"

        # Post summary message
        result = self._slack.chat_postMessage(
            channel=channel_id,
            thread_ts=thread_ts,
            text=f":dart: *Epic:* <{epic_url}|{epic_key}> â€” {epic_summary}",
        )
        message_ts = result["ts"]

        # Pin the message
        try:
            self._slack.pins_add(channel=channel_id, timestamp=message_ts)
        except Exception as e:
            logger.warning(f"Failed to pin epic message: {e}")

        return ThreadJiraLink(
            channel_id=channel_id,
            thread_ts=thread_ts,
            epic_key=epic_key,
            pin_ts=message_ts,
        )

    async def on_ticket_created(
        self,
        channel_id: str,
        thread_ts: str,
        ticket_key: str,
        ticket_url: str,
        existing_pin_ts: Optional[str] = None,
    ) -> ThreadJiraLink:
        """Called when ticket is created from thread.

        Updates existing pin or creates new one with ticket link.

        Args:
            channel_id: Slack channel.
            thread_ts: Thread root timestamp.
            ticket_key: Created Jira ticket key.
            ticket_url: URL to the ticket.
            existing_pin_ts: Existing pinned message to update.

        Returns:
            ThreadJiraLink with updated info.
        """
        if existing_pin_ts:
            # Update existing message
            try:
                self._slack.chat_update(
                    channel=channel_id,
                    ts=existing_pin_ts,
                    text=f":white_check_mark: *Ticket Created:* <{ticket_url}|{ticket_key}>",
                )
            except Exception as e:
                logger.warning(f"Failed to update pin: {e}, posting new message")
                existing_pin_ts = None

        if not existing_pin_ts:
            # Post new pinned message
            result = self._slack.chat_postMessage(
                channel=channel_id,
                thread_ts=thread_ts,
                text=f":white_check_mark: *Ticket Created:* <{ticket_url}|{ticket_key}>",
            )
            message_ts = result["ts"]

            try:
                self._slack.pins_add(channel=channel_id, timestamp=message_ts)
            except Exception as e:
                logger.warning(f"Failed to pin ticket message: {e}")

            existing_pin_ts = message_ts

        return ThreadJiraLink(
            channel_id=channel_id,
            thread_ts=thread_ts,
            ticket_key=ticket_key,
            pin_ts=existing_pin_ts,
        )

    def get_thread_permalink(self, channel_id: str, thread_ts: str) -> str:
        """Get Slack permalink for a thread.

        Used when creating Jira ticket to store link back to Slack.
        """
        try:
            result = self._slack.chat_getPermalink(
                channel=channel_id,
                message_ts=thread_ts,
            )
            return result["permalink"]
        except Exception as e:
            logger.warning(f"Failed to get permalink: {e}")
            return ""
```

Update src/context/__init__.py to export JiraLinker.
  </action>
  <verify>python -c "from src.context.jira_linker import JiraLinker, ThreadJiraLink; print('ok')"</verify>
  <done>JiraLinker class with on_epic_bound, on_ticket_created, get_thread_permalink</done>
</task>

<task type="auto">
  <name>Task 2: Integrate JiraLinker with epic binding flow</name>
  <files>src/slack/binding.py</files>
  <action>
Update `bind_epic()` in src/slack/binding.py to call JiraLinker:

After the existing bind_epic logic (updating session with epic_id), add:

```python
# Post and pin epic link message
try:
    from src.context.jira_linker import JiraLinker
    from src.jira.client import JiraService
    from src.config.settings import get_settings

    settings = get_settings()
    jira = JiraService(settings)

    linker = JiraLinker(client, jira)

    # Get epic summary from Jira (or use epic_key if unavailable)
    try:
        epic = await jira.get_issue(epic_key)
        epic_summary = epic.summary
    except Exception:
        epic_summary = "Epic"

    await linker.on_epic_bound(
        channel_id=channel_id,
        thread_ts=thread_ts,
        epic_key=epic_key,
        epic_summary=epic_summary,
    )

    await jira.close()
except Exception as e:
    logger.warning(f"Failed to create epic pin: {e}")
    # Non-blocking - don't fail the binding
```

This should be after `await session_store.update_epic(...)` succeeds.
  </action>
  <verify>python -c "from src.slack.binding import bind_epic; print('ok')"</verify>
  <done>Epic binding creates pinned message in thread</done>
</task>

<task type="auto">
  <name>Task 3: Integrate JiraLinker with ticket creation</name>
  <files>src/slack/handlers.py</files>
  <action>
Update `handle_approve_draft()` in src/slack/handlers.py.

After the successful jira_create call (where we have `result.jira_key` and `result.jira_url`), add:

```python
# Update thread pin with ticket link
try:
    from src.context.jira_linker import JiraLinker
    from src.jira.client import JiraService
    from src.config.settings import get_settings

    settings = get_settings()
    jira = JiraService(settings)

    linker = JiraLinker(client, jira)
    await linker.on_ticket_created(
        channel_id=channel,
        thread_ts=thread_ts,
        ticket_key=result.jira_key,
        ticket_url=result.jira_url,
        existing_pin_ts=None,  # Could track from epic binding if available
    )

    await jira.close()
except Exception as e:
    logger.warning(f"Failed to update ticket pin: {e}")
    # Non-blocking
```

Also: Update the JiraService.create_issue to include Slack permalink in description.
In the `_format_description()` helper (in jira_create.py or handlers.py), add permalink:

```python
# Get Slack permalink
permalink = linker.get_thread_permalink(channel, thread_ts)
if permalink:
    description += f"\n\n---\n*Slack thread:* {permalink}"
```
  </action>
  <verify>python -c "from src.slack.handlers import handle_approve_draft; print('ok')"</verify>
  <done>Ticket creation updates thread pin and includes Slack permalink in Jira</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.context.jira_linker import JiraLinker"` succeeds
- [ ] `python -c "from src.context import JiraLinker"` succeeds
- [ ] JiraLinker has on_epic_bound, on_ticket_created, get_thread_permalink
- [ ] bind_epic creates pinned message
- [ ] handle_approve_draft updates pin on ticket creation
</verification>

<success_criteria>

- JiraLinker posts and pins summary message on epic binding
- Pin updated when ticket created (not new pin)
- Slack permalink stored in Jira ticket description
- All operations non-blocking (failures logged but don't break flow)
- ThreadJiraLink tracks pin_ts for updates
</success_criteria>

<output>
After completion, create `.planning/phases/08-global-state/08-04-SUMMARY.md`
</output>
