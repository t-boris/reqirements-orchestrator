---
phase: 02-database-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/db/__init__.py, src/db/connection.py]
autonomous: true
---

<objective>
Establish PostgreSQL database connection with async support using psycopg.

Purpose: Provide reliable database connectivity for checkpointer and session storage.
Output: Database connection module with get_connection() async context manager.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior work:
- Settings class has database_url: str = "postgresql://localhost:5432/jira_analyst"
- Configuration pattern: from src.config import get_settings

@src/config/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database connection module</name>
  <files>src/db/connection.py</files>
  <action>
Create async database connection utilities using psycopg (async version).

Implementation:
1. Import psycopg (not psycopg2 - we need async support)
2. Create async connection pool using AsyncConnectionPool
3. Create get_connection() async context manager that yields connections from pool
4. Create init_db() async function to initialize pool (call once at startup)
5. Create close_db() async function to close pool (call at shutdown)
6. Handle connection errors with clear messages

Note: Use psycopg (version 3) not psycopg2 for async. We have psycopg2-binary installed but need to add psycopg[binary] to pyproject.toml.

Connection string comes from get_settings().database_url
  </action>
  <verify>python -c "from src.db.connection import get_connection, init_db, close_db; print('imports ok')"</verify>
  <done>Connection module exports get_connection, init_db, close_db</done>
</task>

<task type="auto">
  <name>Task 2: Add psycopg[binary] to dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add psycopg[binary] to dependencies list in pyproject.toml for async PostgreSQL support.

Keep psycopg2-binary for now (some tools may use it), but add:
- "psycopg[binary]>=3.1"

This provides async support via psycopg.AsyncConnection and psycopg.AsyncConnectionPool.
  </action>
  <verify>pip install -e . && python -c "import psycopg; print(psycopg.__version__)"</verify>
  <done>psycopg v3 available for import</done>
</task>

<task type="auto">
  <name>Task 3: Create db package with exports</name>
  <files>src/db/__init__.py</files>
  <action>
Create src/db/__init__.py that exports:
- get_connection (async context manager)
- init_db (async startup function)
- close_db (async shutdown function)

Pattern: from src.db import get_connection, init_db, close_db
  </action>
  <verify>python -c "from src.db import get_connection, init_db, close_db; print('package exports ok')"</verify>
  <done>Clean package exports available</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds
- [ ] `python -c "from src.db import get_connection, init_db, close_db"` succeeds
- [ ] psycopg v3 importable
- [ ] No import errors
</verification>

<success_criteria>

- All tasks completed
- Database connection module ready for use by checkpointer
- Async support available via psycopg v3
- Clean imports from src.db
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-layer/02-01-SUMMARY.md`
</output>
