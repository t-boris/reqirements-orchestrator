---
phase: 02-database-layer
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/db/models.py, src/db/session_store.py, src/db/__init__.py]
autonomous: true
---

<objective>
Create database models and storage for thread sessions and channel context.

Purpose: Persist thread-to-ticket mapping and channel context for proactive analyst behavior.
Output: SessionStore class for CRUD operations on session data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior work:
- 02-01 establishes database connection utilities
- AgentState has thread_ts, channel_id, user_id fields
- One thread = one session = one potential Jira ticket

Key design:
- Thread-first architecture: session keyed by (channel_id, thread_ts)
- Session stores: status, draft ticket data, created_at, updated_at
- Channel context: accumulated knowledge per channel (future Phase 8)

@src/schemas/state.py
@src/schemas/ticket.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database models module</name>
  <files>src/db/models.py</files>
  <action>
Create Pydantic models for database records (not ORM - we use raw SQL with psycopg).

Models:
1. ThreadSession - represents one conversation session
   - id: str (UUID)
   - channel_id: str
   - thread_ts: str (Slack timestamp, unique with channel_id)
   - user_id: str (initiating user)
   - status: Literal["collecting", "ready_to_sync", "synced"]
   - jira_key: Optional[str] (after ticket created)
   - created_at: datetime
   - updated_at: datetime

2. ChannelContext - channel-level accumulated context (placeholder for Phase 8)
   - id: str (UUID)
   - channel_id: str (unique)
   - context_data: dict (JSON blob for flexible storage)
   - updated_at: datetime

These are data transfer objects, not ORM models. SQL in session_store.py.
  </action>
  <verify>python -c "from src.db.models import ThreadSession, ChannelContext; print('models ok')"</verify>
  <done>ThreadSession and ChannelContext models defined</done>
</task>

<task type="auto">
  <name>Task 2: Create session store with SQL operations</name>
  <files>src/db/session_store.py</files>
  <action>
Create SessionStore class with async CRUD operations using psycopg.

Methods:
1. __init__(conn) - takes async connection
2. create_tables() - CREATE TABLE IF NOT EXISTS for sessions and channel_context
3. get_or_create_session(channel_id, thread_ts, user_id) -> ThreadSession
4. update_session(session_id, status, jira_key=None) -> ThreadSession
5. get_session_by_thread(channel_id, thread_ts) -> Optional[ThreadSession]
6. list_sessions_by_channel(channel_id) -> list[ThreadSession]

SQL operations use parameterized queries (prevent SQL injection).
Use uuid.uuid4() for new IDs.
Store timestamps as TIMESTAMPTZ.

Table schema:
```sql
CREATE TABLE IF NOT EXISTS thread_sessions (
    id UUID PRIMARY KEY,
    channel_id TEXT NOT NULL,
    thread_ts TEXT NOT NULL,
    user_id TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'collecting',
    jira_key TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(channel_id, thread_ts)
);

CREATE TABLE IF NOT EXISTS channel_context (
    id UUID PRIMARY KEY,
    channel_id TEXT UNIQUE NOT NULL,
    context_data JSONB DEFAULT '{}',
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```
  </action>
  <verify>python -c "from src.db.session_store import SessionStore; print('store ok')"</verify>
  <done>SessionStore class with all CRUD methods</done>
</task>

<task type="auto">
  <name>Task 3: Update db package exports</name>
  <files>src/db/__init__.py</files>
  <action>
Add model and store exports to src/db/__init__.py:
- ThreadSession
- ChannelContext
- SessionStore

Keep existing exports from 02-01 and 02-02.
  </action>
  <verify>python -c "from src.db import ThreadSession, ChannelContext, SessionStore; print('exports ok')"</verify>
  <done>All db components available from src.db</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.db import ThreadSession, SessionStore"` succeeds
- [ ] Models have correct fields with types
- [ ] SessionStore has all CRUD methods
- [ ] No import errors
</verification>

<success_criteria>

- All tasks completed
- Thread session model ready for agent state persistence
- SessionStore provides CRUD for session management
- Channel context model ready for Phase 8
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-layer/02-03-SUMMARY.md`
</output>
