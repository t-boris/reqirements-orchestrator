---
phase: 11.2-progress-status-indicators
plan: 03
type: execute
wave: 2
depends_on: ["11.2-01"]
files_modified: [src/slack/blocks.py, src/skills/preview_ticket.py, src/slack/handlers.py]
autonomous: true
---

<objective>
Add draft state indicators to preview messages.

Purpose: Show draft lifecycle state (Draft/Approved/Created) in preview header.
Output: Preview messages display current state badge.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.2-progress-status-indicators/11.2-CONTEXT.md

@src/slack/blocks.py
@src/skills/preview_ticket.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add draft state badges to blocks</name>
  <files>src/slack/blocks.py</files>
  <action>
Add draft state indicator to preview blocks header.

Create state badge function:
```python
def get_draft_state_badge(state: str) -> str:
    """Return emoji badge for draft state."""
    badges = {
        "draft": "ðŸŸ¡ Draft",
        "approved": "ðŸŸ¢ Approved",
        "created": "âœ… Created",
        "linked": "ðŸ”— Linked",
    }
    return badges.get(state, "ðŸŸ¡ Draft")
```

Modify build_draft_preview_blocks_with_hash() to accept state parameter:
```python
def build_draft_preview_blocks_with_hash(
    draft: TicketDraft,
    session_id: str,
    draft_hash: str,
    evidence_permalinks: Optional[list[dict]] = None,
    potential_duplicates: Optional[list[dict]] = None,
    validator_findings: Optional[dict[str, Any]] = None,
    draft_state: str = "draft",  # NEW
) -> list[dict]:
```

Add state badge to header block (first block after header):
```python
# After header section
blocks.append({
    "type": "context",
    "elements": [{
        "type": "mrkdwn",
        "text": get_draft_state_badge(draft_state)
    }]
})
```
  </action>
  <verify>python -c "from src.slack.blocks import get_draft_state_badge; print(get_draft_state_badge('draft'))"</verify>
  <done>Draft state badges render in preview blocks</done>
</task>

<task type="auto">
  <name>Task 2: Pass state through preview flow</name>
  <files>src/skills/preview_ticket.py, src/slack/handlers.py</files>
  <action>
Update preview_ticket to accept and pass draft_state.

In preview_ticket.py:
```python
async def preview_ticket(
    client: AsyncWebClient,
    channel: str,
    thread_ts: str,
    draft: TicketDraft,
    session_id: str,
    potential_duplicates: Optional[list[dict]] = None,
    draft_state: str = "draft",  # NEW
) -> PreviewResult:
```

Pass to blocks builder:
```python
blocks = build_draft_preview_blocks_with_hash(
    draft=draft,
    session_id=session_id,
    draft_hash=draft_hash,
    potential_duplicates=potential_duplicates,
    draft_state=draft_state,
)
```

In handlers.py, update preview message after approval:
1. When approved, update preview with state="approved"
2. When ticket created, update preview with state="created"
3. When linked to duplicate, update preview with state="linked"

Use client.chat_update() to modify existing preview message:
```python
# After approval
blocks = build_draft_preview_blocks_with_hash(
    draft=draft,
    session_id=session_id,
    draft_hash=draft_hash,
    draft_state="approved",
)
await client.chat_update(
    channel=channel,
    ts=preview_ts,
    blocks=blocks,
)
```
  </action>
  <verify>Manual test: approve draft, see state change from "Draft" to "Approved"</verify>
  <done>Draft state flows through preview lifecycle</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Preview shows "ðŸŸ¡ Draft" badge initially
- [ ] After approval, shows "ðŸŸ¢ Approved"
- [ ] After ticket creation, shows "âœ… Created"
- [ ] After linking to duplicate, shows "ðŸ”— Linked"
</verification>

<success_criteria>
- All tasks completed
- Draft state is visible at all lifecycle stages
- State updates are reflected in existing preview message
</success_criteria>

<output>
After completion, create `.planning/phases/11.2-progress-status-indicators/11.2-03-SUMMARY.md`
</output>
